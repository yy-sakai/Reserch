\documentclass{jsarticle}
%
\usepackage{type1cm}
\usepackage{amsthm}
\usepackage{color}

\usepackage[dvipdfmx]{graphicx}
\usepackage{listings,jvlisting}
\usepackage{float}
\usepackage{here, amsmath, latexsym, amssymb, bm, ascmac, mathtools, multicol, tcolorbox,graphicx, comment, pgfplots}
\usepackage{algpseudocode}
\usepackage{algorithm}
\usepackage{tikz}
\usepackage{siunitx}
\usepackage{subcaption}
\usepackage{booktabs}
\usetikzlibrary{intersections}
\usepgfplotslibrary{fillbetween}






%

% 「%」は以降の内容を「改行コードも含めて」無視するコマンド
\usepackage[%
 dvipdfmx,% 欧文ではコメントアウトする
 setpagesize=false,%
 bookmarks=true,%
 bookmarksdepth=tocdepth,%
 bookmarksnumbered=true,%
 colorlinks=true,%
 citecolor=green,%
 urlcolor=magenta,%
 linkcolor=blue,%
 pdftitle={},%
 pdfsubject={},%
 pdfauthor={},%
 pdfkeywords={}%
]{hyperref}
% PDFのしおり機能の日本語文字化けを防ぐ((u)pLaTeXのときのみかく)
\usepackage{pxjahyper}


\newtheorem{thm}{Theorem}[section]
\newtheorem{cor}{Corollary} [section]
\newtheorem{lem}{Lemma}[section]
\newtheorem{prop}{Proposition}[section]
\theoremstyle{definition}
\newtheorem{dfn}{Definition}[section]
\newtheorem{ex}{Example}[section]
\newtheorem{rem}{Remark}[section]
\newtheorem{ass}{Assuption}[section]

\renewcommand{\labelenumi}{(\roman{enumi})}

%
\lstset{
  basicstyle={\ttfamily},
  identifierstyle={\small},
  commentstyle={\smallitshape},
  keywordstyle={\small\bfseries},
  ndkeywordstyle={\small},
  stringstyle={\small\ttfamily},
  frame={tb},
  breaklines=true,
  columns=[l]{fullflexible},
  numbers=left,
  xrightmargin=0zw,
  xleftmargin=3zw,
  numberstyle={\scriptsize},
  stepnumber=1,
  numbersep=1zw,
  lineskip=-0.5ex
}

\title{Note  "THE BACK-AND-FORTH METHOD FOR WASSERSTEIN GRADIENT FLOWS"}

\author{坂井幸人}

\date{\today}

\begin{document}
\maketitle

\begin{abstract}
    ワッサーシュタイン勾配流を効率的に計算する方法を提案。
    アプローチは、最適輸送問題を解くためにJacobsとL$\acute{e}$gerが導入した往復法（BFM）の一般化に基づいています[Numer. Math. 146（2020）513-544.]。
    JKOスキームの双対問題を解くことにより、勾配流を進化させる。
    一般的に、双対問題は原始問題よりも扱いやすい。
    これにより、特異な非凸エネルギーを含む多くの内部エネルギーに対して、大規模な勾配流シミュレーションを効率的に実行することができる。
\end{abstract}

\section{INTRODUCTION}

この研究では、以下のような形式の放物型方程式の進化シミュレーションに興味があります。

\begin{align}
    \begin{split}
        \label{eq:Darcy's}
        \partial_t \rho - \nabla \cdot (\delta \nabla \phi) = 0, \\
        \phi = \delta U(\rho).
    \end{split}
\end{align}


方程式(\ref{eq:Darcy's})はしばしばダルシーの法則または一般化された多孔質媒体方程式と呼ばれ、内部エネルギー関数 $U$ によって生成された圧力勾配 $\nabla \phi$ に沿って流れる質量密度 $\rho$ の進化を記述します。
このクラスの方程式は、流体流、熱伝導、拡散(律速)凝集、人流など、さまざまな物理現象をモデル化します。
一般的に、{\color{red}これらの方程式は剛性があり非線形であり、数値的に解くのは困難です。}
例えば、
$$
    U(\rho) = \frac{1}{m - 1} \int \rho^m (m > 1)
$$
の重要な特殊な場合では、方程式(\ref{eq:Darcy's})は熱方程式の非線形バージョンである多孔質媒体方程式（PME） 
$$
    \partial_t \rho - \delta(\rho^m = 0)
$$
となる。


$U$が微分不可能または凸でない場合、これらの方程式のシミュレーションはさらに困難。
したがって、この論文では、多種多様な内部エネルギー$U$の式(\ref{eq:Darcy's})を効率的かつ正確にシミュレートするための手法を設計することを目標としています。\\

私たちのDarcyの法則のシミュレーション手法は、方程式(\ref{eq:Darcy's})をWasserstein距離に関する勾配流として解釈するという優れたアプローチに基づいています[19, 25]。
この解釈は、JKOスキームとして知られる離散時間近似法を作成するために使用することができます[19]。
このスキームは、次の反復によって近似解を構築します。


\begin{equation}
    \label{eq:minimizer}
    \min_{\rho \in \mathcal{P}} U(\rho) + \frac{1}{2\tau} W_2^2(\rho, \mu)
\end{equation}
\[
    \rho^{(n+1)} := \arg\min_{\rho} U(\rho) + \frac{1}{2\tau} W_2^2(\rho, \rho^{(n)})
\]

ここで、$\tau$はスキーム内の時間ステップを表し、$W_2(\cdot, \cdot)$は最適輸送理論の2-Wasserstein距離です[27]（最適輸送と2-Wasserstein距離の簡単な概要についてはセクション2.1を参照）。
{\color{teal}スキームの変分的構造により、}反復解は無条件でエネルギー安定性を持ち、時間ステップ$\tau$を任意の空間離散化から独立して選択することができます。
さらに、JKOスキームは連続方程式の比較型や収縮型の原理など、多くの望ましい特性を保持しています[1, 10, 20]。\\

JKOスキームの多くの有利な特性を考慮すると、問題（\ref{eq:minimizer}）の最小化問題の計算に多くの研究が注がれてきました。
例えば、[2-4, 6-9, 22, 26]などが挙げられます。
この問題に関する研究が多く行われているにも関わらず、高い解像度でJKOスキームを効率的に解くことは依然として課題です。
{\color{red}
問題（\ref{eq:minimizer}）を解く上での主な困難は、Wasserstein距離項の扱いです。
実際、密度$\rho$に関するWasserstein距離の変動を与える簡単な公式は存在しません。
そのため、（\ref{eq:minimizer}）を解くためのほぼすべての方法は、2つの固定された密度間のWasserstein距離を計算するアルゴリズムの適応である。\\
}

この論文では、[21]で紹介されたback-and-forth method (BFM)を適応して、問題（\ref{eq:minimizer}）を解決します。
BFMは、2つの固定された密度間の最適輸送写像を計算するための最先端のアルゴリズムです。
{\color{red}
BFMは、モンジュの最適輸送問題を直接解くのではなく、関連するカントロビッチの双対問題を解くことによって最適写像を見つけます。
このアプローチを基に、直接問題（\ref{eq:minimizer}）を解く代わりに、その双対問題の解を計算します。
双対問題は凹最大化問題であり、次の時刻ステップの圧力変数$\phi^{(n + 1)}$を生成します。
最適密度変数は、圧力との双対関係$\phi^{(n+1)} = \delta U(\rho^{(n+1)})$を介して簡単に回復することができます。\\
}

双対問題を解くことによる利点はいくつかあります。
圧力変数$\phi$は密度変数$\rho$よりも正則性が高いです。
最悪の場合でも、圧力の勾配は\hyperlink{自乗可積分}{自乗可積分}である必要があります。
その結果、圧力は離散的な近似スキームに適しています。
さらに、双対汎関数の微分を計算するための明示的な式があるので、双対問題を解くために勾配上昇法を適用することができます（原始問題に対応する勾配降下法ははるかに困難です）。
最後に、密度の非圧縮性など、$U$が厳しい制約を表現している場合（例: 密度の非圧縮性）、双対問題は制約のない形で表現されるため、双対アプローチは非常に便利です。\\

{\color{red}
（\ref{eq:minimizer}）の双対問題とBFMの特殊な勾配上昇構造を活用することで、内部エネルギー$U$の広範なクラスに対してJKOスキームを迅速かつ正確に解くことができます。
我々は、アルゴリズムが各ステップで双対問題の値を増加させることを示しています。
特に、この解析は$U$のHessianが特異である場合や、計算グリッドのサイズに依存しない場合でも成立します。
その結果、従来の方法よりもはるかに大規模なスケールで式(\ref{eq:Darcy's})をシミュレートすることができ、
障害物を持つ非圧縮性のある群衆モデルや集合拡散方程式（aggregation-diffusion equations）のような難解なケースを簡単に扱うことができます。
}

\subsection{Overall approach}

Wasserstein勾配流におけるback-and-forth法は、JKOスキームに関連する双対問題を解くことに基づいています。
この分析の出発点は、Kantorovichの最適輸送の双対形式です。
2つの測度$\mu$と$\nu$が与えられた場合、2-Wasserstein距離の双対形式は次のようになります。

\begin{equation}
    \frac{1}{2 \tau}W_2^2(\mu, \nu) = \sup_{(\psi(x), \varphi(y)) \in C}  \left\{ \int \psi(x) d\mu(x) + \int \varphi(y) d\nu(y) \right\},
\end{equation}

ここで、以下の制約条件を満たす範囲で最大化されます。

$$
    \mathcal{C}  := \{(\varphi, \psi) \in C(\Omega) \times C(\Omega) : \psi(x) + \varphi(y) \leq \frac{1}{2 \tau} |x - y|^2 \}. 
$$
\vspace\baselineskip 

{\color{teal}
最適輸送の双対形式を用いると、問題（\ref{eq:minimizer}）を次のように書き直すことができます。
}
\begin{align*}
    \min_{\rho \in \mathcal{P}} U(\rho) + \frac{1}{2\tau} W_2^2(\rho, \mu) &= \min_{\rho \in \mathcal{P}} \left(U(\rho) + \sup_{(\varphi, \psi) \in \mathcal{C}} \left(\int \varphi \, d\rho + \int \psi \, d\mu\right)\right)\\
                                                                            &= \min_{\rho \in \mathcal{P}} \sup_{(\varphi, \psi) \in \mathcal{C}} \left(U(\rho) + \int \varphi \, d\rho + \int \psi \, d\mu\right)
  \end{align*}
$U$が凸である場合、infとsupを入れ替えることで、（\ref{eq:minimizer}）と同等の双対問題を得ることができます。[YS](P2.detail)
\begin{align*}
    \min_{\rho \in \mathcal{P}} U(\rho) + \frac{1}{2\tau} W_2^2(\rho, \mu) &= \sup_{(\varphi, \psi) \in \mathcal{C}} \min_{\rho \in \mathcal{P}} \left(U(\rho) + \int \varphi \, d\rho + \int \psi \, d\mu \right),\\
                                                                            &= \sup_{(\varphi, \psi) \in \mathcal{C}} \left(\min_{\rho \in \mathcal{P}} \left(U(\rho) + \int \varphi \, d\rho\right) + \int \psi \, d\mu\right),\\
                                                                            &= \sup_{(\varphi, \psi) \in \mathcal{C}} \left(\int \psi \, d\mu - U^*(- \varphi)\right).\\
  \end{align*}
\begin{equation}
    \label{eq:dual}
    \sup_{(\phi,\psi) \in \mathcal{C}} \int \psi(x) d\rho^{(n)}(x) - U^*(- \varphi) ,
\end{equation} 
ここで、$U^*$は$U$の(\hyperlink{凸共役}{凸共役})を表し、次のように定義されます。

\begin{align*}
    U^*(\varphi) &:= \sup_{\rho \in \mathcal{P}} \left( \int \varphi \, d \rho - U(\rho)\right)\\
    U^*(- \varphi) &= - \inf_\rho \left(\int \varphi(y) d\rho(y) + U(\rho) \right).
    \end{align*}

この双対問題を解くことで、問題（\ref{eq:minimizer}）の双対変数$\varphi$を得ることができる。
また、Legendre 変換 (\hyperlink{凸共役}{凸共役})を用いて双対変数から密度変数を容易に復元することもできる。\\

問題(\ref{eq:dual})は、$\mathcal{C}$によって表現される制約のために困難に見える。
しかし、問題を再定式化する非常に便利な方法があります。$\rho^{(n)}(\mu)$が非負測度であるため、できるだけ大きな値を持つように$\psi$を選ぶことが好ましい。

$\phi$を固定すれば、対応する$\psi$の最大可能な選択肢は次のようになる。
\begin{equation}
    \label{eq:backward-c-transform}
    \phi^c(x) := \inf_{y\in\Omega} \frac{1}{2 \tau}|x - y|^2 - \phi(y).
\end{equation}
また、$\mu \ge 0$より,$\psi$を固定すると、$\phi$の最大の選択肢は次のようになる。
\begin{equation}
    \label{eq:forward-c-transform}
    \psi^c(y) := \inf_x \left( \frac{1}{2\tau}|x-y|^2 - \psi(x)\right)
\end{equation}


式(\ref{eq:backward-c-transform})と(\ref{eq:forward-c-transform})はそれぞれbackward-c-transformとforward-c-transformとして知られています。
これらの変換は最適輸送において重要な役割を果たし、私たちの手法には不可欠です。
重要な点として、これらの変換を使用して制約$\mathcal{C}$と$\phi$または$\psi$のいずれかを排除することができます。\\

注意しておきますが、
{\color{teal}
与えられた \((\varphi, \psi) \in C\) に対して、{\color{red}\(\psi^c \geq \varphi\) }が成り立ちます。
}
なぜなら、
$
    \mathcal{C}  := \{(\varphi, \psi) \in C(\Omega) \times C(\Omega) : \psi(x) + \varphi(y) \leq \frac{1}{2 \tau} |x - y|^2 \}. 
$
であり,
$
  \varphi(x) \le \frac{1}{2\tau}|x-y|^2 - \psi(y)
$
なので、右辺で$\inf$をとっているので、左辺の$\varphi(x)$の中での$\sup$が$\psi^c$になるためである。\\

また、\(\rho \geq 0\) の場合、\(- U^*(-\varphi)\) は \(\varphi\) に関して減少しない関数です。
よって、{\color{red}$-U^*(- \varphi) \le -U^*(- \psi^c)$}である。


したがって、以下のようになります。
\[
\sup_{(\varphi, \psi) \in C} \left(\int \psi \, d\mu - U^*(- \varphi)\right) \le \sup_\psi \left(\int \psi \, d\mu - U^*(- \psi^c)\right)
\]

また、$(\varphi, \psi) \in \mathcal{C} \implies (\psi^c, \psi) \in \mathcal{C}$
であるので,
\[
\sup_{(\varphi, \psi) \in C} \left(\int \psi \, d\mu - U^*(- \varphi)\right) \ge \sup_\psi \left(\int \psi \, d\mu - U^*(- \psi^c)\right)
\]
が成立する。よって,
\begin{equation}
  \label{eq:psi^c}
\sup_{(\varphi, \psi) \in C} \left(\int \psi \, d\mu - U^*(- \varphi)\right) = \sup_\psi \left(\int \psi \, d\mu - U^*(- \psi^c)\right)
\end{equation}

同様に、\(\mu \geq 0\) であるため、

\begin{equation}
  \label{eq:phi^c}
  \sup_{(\varphi, \psi) \in C} \left(\int \psi \, d\mu - U^*(- \varphi)\right) = \sup_\varphi \left(\int \varphi^c \, d\mu - U^*(- \varphi)\right)
\end{equation}
となります。\\

\vspace\baselineskip 

$c$-変換(\ref{eq:backward-c-transform})(\ref{eq:forward-c-transform})を使用して制約$\mathcal{C}$と$\phi$または$\psi$のいずれかを排除することによって、問題(\ref{eq:dual})は次の2つの制約のない汎関数の最大化として等価になる:
\begin{equation}
    \label{eq:J}
    J(\phi):= \int_{\Omega} \phi^c(x) \,d\rho^{(n)}(x) - U^*(- \phi)
\end{equation}

\begin{equation}
    \label{eq:I}
    I(\psi):= \int_{\Omega} \psi(x) \, d\rho^{(n)}(x) - U^*(- \psi^{c})
\end{equation}

すなわち、
$$
\sup_{(\phi,\psi) \in \mathcal{C}} \int \psi(x) d\rho^{(n)}(x) - U^*(- \phi) = \sup J(\phi) = \sup I(\psi).
$$
加えて、もし$\phi_*$が$J$の最大化関数であり、$\psi_*$が$I$の最大化関数であるならば、
$$
    \phi_*^c = \psi_*, \qquad \psi_*^c = \phi_*
$$
の関係が成り立ち、$(\phi_*, \psi_*)$は(\ref{eq:dual})の最大化関数となります。
$I$と$J$の再定式化は、最大化関数を見つける作業を実際に簡素化します。
正規の離散グリッド上では、$c$-transformは非常に効率的に計算できます[21, 23]。
その結果、(\ref{eq:dual})を直接扱うよりも、IとJを最大化する方がはるかに取り扱いやすくなります。\\


私たちは、[21]で紹介されたBFMアルゴリズムを基にして、最大化関数$\phi_*$と$\psi_*$を見つける。
元のBFMは、$U^*$が線形関数という特別な場合に最大化関数を効率的に見つけるための手法を提供している。
$I$または$J$に焦点を当てるよりも早く、BFMは両方の関数を同時に最大化します。
この手法は、$\phi$-空間での$J$の勾配上昇更新と$\psi$-空間での$I$の勾配上昇更新を交互に行うことで進行します（そのため、「back-and-forth」の名前があります）。
勾配ステップの間には、一方の空間（$\phi$-空間または$\psi$-空間）の情報を他方に伝達するために、前方/後方$c$-transformを適用します。
[21]で指摘されているように、back-and-forthアプローチの利点は、最適解のペア$(\phi_*, \psi_*)$の特定の特徴が、片方の空間よりも他方の空間でより簡単に構築できることです。
その結果、back-and-forth法は、$\phi$-空間のみまたは$\psi$-空間のみで操作する通常の勾配上昇法よりもはるかに迅速に収束します。\\

Wasserstein gradient flowの場合にBFMを一般化するためには、$U^*$が非線形の場合に(\ref{eq:J})と(\ref{eq:I})の勾配上昇ステップの安定性を保証する必要があります。
実際には、多くの重要なケースでは、$U^*$のHessianには特異成分が存在する可能性があります。
この困難を克服するために、適切に重み付けされたSobolev空間で勾配上昇ステップを行います。
Sobolev制御により、境界積分を全空間上の積分に変換することができ、$U^*$の特異性を抑えることができます（詳細はセクション3.2を参照）。
この連続解析の結果、離散化スキームは格子サイズに依存しない収束率を持つことになります。
back-and-forth法は、Algorithm 1にまとめられています。ここで、$H$は前述の重み付きSobolev空間です。\\

\begin{algorithm}[tb]
    \caption{The back-and-forth scheme for solving(\ref{eq:dual})}
    \begin{algorithmic}
    \State{Given $\rho^{(n)}[t]$ and $\phi_0$, iterate:}
    \State{
        \begin{align*}
            \phi_{k + \frac{1}{2}} &= \phi_k + \nabla_H J(\phi_k)\\
            \psi_{k + \frac{1}{2}} &= (\phi_{k + \frac{1}{2}})^c\\
            \psi_{k + 1} &= \phi_{k + \frac{1}{2}} + \nabla_H I(\phi_{k + \frac{1}{2}})\\
            \phi_{k + 1} &= (\psi_{k + 1})^c
        \end{align*}
    }
    \end{algorithmic}
\end{algorithm}

一度双対問題を解決した後、元の問題（\ref{eq:minimizer}）の解を回復することができます。
$U$が凸であれば、最適な双対変数$\phi_*$は$\rho^{(n+1)}$との双対関係
{\color{red}
$$
    \rho^{(n+1)} = \delta U^*(\phi_*)
$$
}
を介して関連付けられます（Section \ref{sect:Convex duality}の定理\ref{thm: duality}を参照）。
$U$が凸でない場合、（\ref{eq:minimizer}）と双対問題との間の関係はより不確かになります。
幸いなことに、凸性分割スキームを使用することで、この困難を回避することができます[12]。
実際に、$U = U_1 + U_0$と書けるようにすると、$U_1$は凸であり、$U_0$は凹であるとします。
その場合、JKOスキーム（\ref{eq:minimizer}）を次の修正されたスキームに置き換えることができます。

\begin{equation}
    \label{eq:JKO}
    \rho^{(n+1)} = \underset{\rho}{\operatorname{argmin}} \, U_1(\rho) + U_0(\rho^{(n)}) + (\delta U_0(\rho^{(n)}), \rho - \rho^{(n)}) + \frac{1}{2 \tau} W^2_2(\rho, \rho^{(n)})
\end{equation}

凸性分割は、完全暗黙のスキームのエネルギー安定性を保持することがよく知られています。
重要なのは、(\ref{eq:JKO})のエネルギー項
$U_1(\rho) + U_0(\rho^{(n)}) + (\delta U_0(\rho^{(n)}), \rho - \rho^{(n)})$は変数$\rho$
に対して凸関数であるため、双対アプローチを適用できることです。
すべてを考慮すると、私たちの方法は$U$が凸でない場合や不規則な場合でも、PDE（\ref{eq:Darcy's}）を非常に迅速にシミュレートする手法を提供します。\\

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%5

\section{BACKGROUND}
\subsection{The $c$-transform and optimal transport}

ここから、$\Omega$上の連続関数の空間を$C(\Omega)$で表す。

\begin{dfn}
    $\phi \in C(\Omega)$の\textit{backward c-transform}は以下のように表す:
    \begin{equation}
        \label{def:backward-c-transform}
        \phi^c(x) := \inf_{y\in\Omega} \left(\frac{1}{2 \tau}|x - y|^2 - \phi(y)\right).
    \end{equation}
    また、$\psi \in C(\Omega)$の\textit{forward c-transform}は以下のように表す:
    \begin{equation}
        \label{def:forward-c-transform}
        \psi^c(y) := \inf_x \left( \frac{1}{2\tau}|x-y|^2 - \psi(x)\right).
    \end{equation}
\end{dfn}

\vspace\baselineskip

\begin{dfn}
    $\phi$が$c$-concaveであるとは、$\phi = \psi^c$となる $\psi \in C(\Omega)$が存在することである。
    また、$(\phi, \psi) \in \mathcal{C}$が$c$-conjugateとは、$\phi = \psi^c$かつ$\psi = \phi^c$であることをいう。
\end{dfn}

\vspace\baselineskip

\begin{lem}
    \label{lem:c-transform}
    \hyperlink{proof:lem:c-transform}{(Proof)}
    $\phi, \psi \in C(\Omega)$のとき,
    $\forall x \in \Omega \text{に対し,}\phi^{cc} \ge \phi$
    が成り立つ。また、$\phi^{cc} = \phi$の必要十分条件は$\phi$が$c$-concaveの時である。
    特に、$\phi^{ccc} = \phi^c$が成立する.[JL](Lemma 1(i))
\end{lem}

\begin{prop}
    \label{prop:transport map}
    \hyperlink{proof:prop:transport map}{(Proof)}
    $\phi \in C(\Omega)$が$c$-concaveのとき,以下の写像はwell-definedかつalmost everywhereでuniqueである。
    \begin{equation}
            T_\phi(x):= \underset{y \in \Omega} {\operatorname{argmin}}\left( \frac{1}{2 \tau} |x - y|^2 - \phi(y) \right) 
    \end{equation}
    言い換えると、最小化問題 $\inf_{y \in \Omega} c(x, y) - \phi(y)$ はほとんど全ての(almost every) $x$ について,
    唯一の最小値を与える関数(最小化関数) $T_\phi(x)$ を持つ。
    すなわち、$c(x, y) - \phi(y)$が最小値を取る時、 $y = T_\phi(x)$である。
    さらに、$u \in C(\Omega)$であるとき、ほとんど全ての(almost every)$x, y \in \Omega$に対し、以下のような$c$-transformの摂動公式が成り立つ。
    \begin{equation}
        \lim_{\varepsilon \to 0} \frac{(\phi + \varepsilon u)^c(x) - \phi^c(x)}{\varepsilon} = - u(T_\phi(x))
    \end{equation}
    最後に、以下も成り立つ。
    $$
        T_\phi(x) = x - \tau \nabla \phi^c(x),
    $$
    $$
        T_\psi(y) = y - \tau \nabla \psi^c(y),
    $$
    {\color{teal}
    また、$T_\phi(T_\psi(y)) = y,\, T_\psi(T_\phi(x)) = x$ がalmost everywhereで成り立つ。
    すなわち、
    $$
        T_\phi^{-1}(y) = y - \tau \nabla \phi(y) 
    $$

    }

    
\end{prop}


\begin{prop}
    \label{prop:wasserstein}
    \hyperlink{proof:prop:wasserstein}{(Proof)}
    もし、$\mu$と$\nu$が$\Omega$上の非負密度関数で、質量が等しい場合、つまり、
    \[
        \int_{\Omega} \mu(x)dx = \int_{\Omega} \nu(y)dy
    \]
    であるならば、次の式が成り立ちます。
    \[
        \frac{1}{2\tau}W_2^2(\mu, \nu) = \sup_{\phi \in C(\Omega)} \left( \int_{\Omega} \phi^c(x) \mu(x)dx + \int_{\Omega} \phi(y) \nu(y)dy \right) 
    \]

    \[
        \frac{1}{2\tau}W_2^2(\mu, \nu) = \sup_{\psi \in C(\Omega)} \left( \int_{\Omega} \psi(x) \mu(x)dx + \int_{\Omega} \psi^c (y) \nu(y)dy \right) 
    \]

%ここで、W2(μ, ν)はWasserstein-2距離を表し、C(\Omega)はΩ上の連続関数の集合を表します。式中のφ(x)はμ(x)dxで積分され、φ(y)はν(y)dyで積分されます。同様に、ψ(x)はμ(x)dxで積分され、ψ(y)はν(y)dyで積分されます。

この結果により、最適輸送写像の存在と一意性が保証されます。
\end{prop}

{\color{teal}
\begin{thm}
    \label{thm:pushforward measure}
    \hyperlink{proof:thm:pushforward measure}{(Proof)}
    もし、$\mu$と$\nu$が$\Omega$上の非負密度関数で、質量が等しい場合、つまり、
    \[
        \int_{\Omega} \mu(x)dx = \int_{\Omega} \nu(y)dy
    \]
    であるならば、次の条件を満たすc共役のペア$(\phi_*, \psi_*)$が存在する:
    \begin{align*}
        \phi_* &\in \underset{\phi \in C(\Omega)} {\operatorname{argmax}}\left\{\int_{\Omega} \phi^c(x) \mu(x)dx + \int_{\Omega} \phi(y) \nu(y)dy \right\} \\
        \psi_* &\in \underset{\psi \in C(\Omega)} {\operatorname{argmax}} \left\{\int_{\Omega} \psi(x) \mu(x)dx +z \int_{\Omega} \psi^c(y) \nu(y)dy \right\}
    \end{align*}
さらに、$T_\phi$は$\mu$を$\nu$に送る唯一の最適輸送写像であり、$T_\psi$は$\nu$を$\mu$に送る唯一の最適輸送写像です。
つまり、$T_{\phi_* \#} \mu = \nu$および$T_{\psi_* \#} \nu = \mu$が成り立ちます。
これを押し出し測度(pushforward measure)という。

また、2-Wasserstein距離$W^2_2(\mu, \nu)$と関数$\phi_*, \psi_*$との関係は次のようになります。

\[
\frac{1}{2\tau}W^2_2(\mu, \nu) = \int_{\Omega} \psi_*(x) \mu(x)dx + \int_{\Omega} \phi_*(y) \nu(y)dy.
\]
\end{thm}
}

\begin{dfn}
    $A \in \Omega$のとき、押し出し測度$T_{\#} \mu$は以下のように定義される:
    \[
      T_\# \mu (A) = \mu (T^{-1}(A))  
    \]
    また、pushforwardをテスト関数$f: \Omega \to \mathbb{R}$に対するpushforward measureの積分として定義すると以下のようになる:
    \begin{equation}
        \label{def:pushforward_int}
        \int_{\Omega} f(y)d\, T_\# \mu (y) = \int_\Omega f(T(x)) d \mu(x).
      \end{equation}
\end{dfn}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Convex duality}
\label{sect:Convex duality}
一般化最適輸送$(GOT)$問題:
\begin{equation}
    \label{eq: GOT}
        \rho_* = \underset{\rho \in L^1(\Omega)} {\operatorname{argmin}} \left( U(\rho) + \frac{1}{2 \tau}W_2^2(\rho, \mu) \right), 
\end{equation}
ここで、$\mu \in L^1(\Omega)$は与えられた非負密度です。

\begin{ass}
    \label{ass:rho>0}
    内部エネルギーUは、properで、凸かつ、下半連続な汎関数 $U: L^1(\Omega) \to \mathbb{R} \cup  \{+ \infty\}$ によって与えられます。
    ただし、$\rho$が正の測度を持つ集合上で負になる場合は $U(\rho) = \infty$ とします。
\end{ass}


\begin{ass}
    \label{ass:weakly compact}
    超線形の成長(superlinear growth)を持つ$s: \mathbb{R} \to \mathbb{R} \cup  \{+ \infty\}$が存在し、以下の条件を満たす:
    $$
        U(\rho) \geq \int_\Omega s(\rho(y)) \, dy
    $$
\end{ass}

\begin{rem}
    仮定\ref{ass:rho>0}は、密度ρが非負である必要があることを表しています。つまり、ρは負の値を取ることはできません。
    これにより、非負の密度に対して関数$U(\rho)$が適切に定義されることが保証されます。
    一方、仮定\ref{ass:weakly compact}は、任意の$B \in \mathbb{R}$に対して、集合$\{ \rho \in L^1(\Omega): U(\rho) < B\}$が弱収束位相において弱コンパクトであることを保証します。
\end{rem}

\begin{rem}
    凸性の要件を除けば、仮定\ref{ass:rho>0}と仮定\ref{ass:weakly compact}はWasserstein勾配流の文脈では非常に自然なものです。
    ただし、セクション3.3では非凸なUも考慮します。
\end{rem}

\begin{dfn}
    関数 $U: L^1(\Omega) \to \mathbb{R}$ の凸共役 $U^*: L^{\infty}(\Omega) \to \mathbb{R}$ は次のように定義されます:
    \begin{align*}
        U^*(\phi) &:= \sup_{\rho \in L^1(\Omega)} \left\{ \int_\Omega \phi(y) \rho(y) dy - U(\rho) \right\},\\
                  &= \sup_{\rho \in L^1(\Omega)} \left\{ \int_\Omega \phi d\rho - U(\rho) \right\}.
    \end{align*}
    仮定 \ref{ass:rho>0}  のおかげで、$U^*$ は重要な単調性を持ちます。
\end{dfn}

\begin{lem}
    \label{lem:monotone increasing}
    \hyperlink{proof:lem:monotone increasing}{(Proof)}
    $U^*$ は単調増加である、つまり、$\phi_0, \phi_1: \Omega \to \mathbb{R}$ が $\phi_0 \leq \phi_1$ となるすべての点で成り立つ場合、次の不等式が成り立ちます。
    $$
        U^*(\phi_0) \leq U^*(\phi_1).
    $$
\end{lem}

注意しておきますが、
{\color{teal}
与えられた \((\varphi, \psi) \in C\) に対して、{\color{red}\(\psi^c \geq \varphi\) }が成り立ちます。
}
同様に、\(\varphi^c \geq \psi\) 
なぜなら、
$
    \mathcal{C}  := \{(\phi, \psi) \in C(\Omega) \times C(\Omega) : \psi(x) + \phi(y) \leq \frac{1}{2 \tau} |x - y|^2 \}. 
$
であり,
$
  \varphi(x) \le \frac{1}{2\tau}|x-y|^2 - \psi(y)
$
なので、右辺で$\inf$をとっているので、左辺の$\varphi(x)$の中での$\sup$が$\psi^c$になるためである。\\

また、\(\rho \geq 0\) の場合、\(- U^*(-\varphi)\) は \(\varphi\) に関して増加する関数です。
よって、{\color{red}$-U^*(\varphi) \le -U^*(\psi^c)$}である。

\begin{prop}
    \label{prop:functional}
    \hyperlink{proof:prop:functional}{(Proof)}
    与えられた非負密度$\mu \in L^1(\Omega)$に対して、汎関数$I$と$J$は以下のように定義される(\ref{eq:J}),(\ref{eq:I}):
    \begin{equation}
        J(\phi):= \int_{\Omega} \phi^c(x) \mu(x) \,dx - U^*(- \phi)
    \end{equation}
    
    \begin{equation}
        I(\psi):= \int_{\Omega} \psi(x)\mu(x) \, dx - U^*(- \psi^{c})
    \end{equation}

    これらの汎関数はproperであり、弱上半連続であり、凹であり、さらに $\sup_{\varphi\in C(\Omega)} J(\varphi) = \sup_{\psi\in C(\Omega)} I(\psi)$ を満たします。
    {\color{teal}
    さらに、$\varphi, \psi$がc-凹である場合、$J$と$I$は以下のような一次変分を持ちます：

    \begin{equation}
        \label{eq:delta J}
        \delta J(\phi) = \delta U^*(- \phi) - T_{\phi \#} \mu,
    \end{equation}
    \begin{equation}
        \label{eq:delta I}
        \delta I(\psi) = \mu - T_{\psi \#} \delta U^* (- \psi^c).
    \end{equation}
    }
\end{prop}

このsubsectionの最後に、$I$と$J$の最大化値から(\ref{eq: GOT})の解を復元する方法を以下に示す。

{\color{teal}
\begin{thm}
\label{thm: duality}
    $\mu \in L^1(\Omega)$であり、$U$がAssumptions \ref{ass:rho>0}と\ref{ass:weakly compact}を満たし、さらに$\delta U(\mu)$が定数関数でない場合、次の条件を満たす一意の密度$\rho_*$と$c$-共役な関数のペア$(\phi_*, \psi_*)$が存在します。
\begin{equation*}
    \rho_* = \underset{\rho \in L^1(\Omega)} {\operatorname{argmin}} \, U(\rho) + \frac{1}{2\tau} W_2(\rho, \mu), \quad \phi_* \in \underset{\phi \in C(\Omega)} {\operatorname{argmax}} \, J(\phi), \quad \psi_* \in \underset{\psi \in C(\Omega)} {\operatorname{argmax}} \, I(\psi),
\end{equation*}

\begin{equation*}
U(\rho_*) + \frac{1}{2\tau} W_2^2(\rho_*,\mu) = J(\phi_*) = I(\psi_*), 
\end{equation*}

\begin{equation*}
    \rho_* \in \delta U^*(\phi_*), \quad \phi_* \in \delta U(\rho_*), \quad \rho_* = T_{\phi_* \#} \mu.
\end{equation*}
\end{thm}
}

\begin{rem}
    注意すべきは、もし$\delta U(\mu)$が定数関数である場合、$\mu = \underset{\rho \in L^1(\Omega)} {\operatorname{argmin}} \, U(\rho) + \frac{1}{2\tau} W_2^2(\rho, \mu)$となります。
    したがって、排除されたケースは自明な場合です。
\end{rem}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Concave gradient ascent}
\label{sect:Concave gradient ascent}

JKOスキームを$I$と$J$の双対関数に関連付ける方法を見てきたので、$I$と$J$の最大化方法を開発する必要があります。
そのために、このサブセクションでは、古典的な制約のない勾配上昇法について説明します。
まず、勾配の概念を思い出す。
これには、実ヒルベルト空間$\mathcal{H}$の内積$\langle\cdot,\cdot\rangle_\mathcal{H}$とノルム$\|\cdot\|_\mathcal{H}$の構造が必要です。

\begin{dfn}
    点$\varphi\in \mathcal{H}$に対して、有界線型写像$\delta F(\varphi): \mathcal{H} \to \mathbb{R}$が$F$の第1変分（フレシェ微分）であるとは、
    \[
        \lim_{\|h\|_{\mathcal{H}} \to 0} \frac{\|F(\varphi + h) - F(\varphi) - \delta F(\varphi)(h)\|_{\mathcal{H}}}{\|h\|_{\mathcal{H}}} = 0
    \]
    が成り立つことである。
\end{dfn}
\begin{dfn}
    写像$\nabla_\mathcal{H} F: \mathcal{H} \to \mathcal{H}$が$\mathcal{H}$-勾配（または単に勾配、$\mathcal{H}$についての曖昧さがない場合）とは,
    \[
        \langle \nabla_\mathcal{H} F(\varphi), h \rangle_\mathcal{H} = \delta F(\varphi)(h)
    \]
    をすべての$(\varphi, h) \in \mathcal{H} \times \mathcal{H}$に対して満たすものを指す。
\end{dfn}

上記の等式は、勾配がヒルベルト空間の内積と密接に関連していることを強調しています。一方、第1変分の概念は、任意のノルム付きベクトル空間上で定義することができますが、勾配の概念は内積を必要とします。



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Gradient ascent method}
\label{sect: Gradient ascent method}

与えられた$\mathcal{H}$上の凹関数$J$に対し、勾配上昇法の反復式
\begin{equation}
    \label{eq:gradient ascent}
    \phi_{k+1} = \phi_k + \nabla_\mathcal{H} J(\phi_k).
\end{equation}
を考える、
勾配上昇法（式(\ref{eq:gradient ascent})）は、次の変分形式でも同等に書くことができます。
\begin{equation}
    \label{eq:gradient ascent variational}
    \phi_{k+1} =  \underset{\phi} {\operatorname{argmax}} J(\phi_k) + \delta J(\phi_k)(\phi-\phi_k) - \frac{1}{2}\|\phi-\phi_k\|_H^2.
\end{equation}
ここで、式(\ref{eq:gradient ascent})と(\ref{eq:gradient ascent variational})には通常、勾配方向でどれだけ進むかを制御するステップサイズパラメータが含まれています。
後で明らかになる理由（式(2.11)とその後の議論を参照）から、パラメータをノルム$\|\cdot\|_\mathcal{H}$自体に組み込むほうがよいことがわかる。

スキームの収束性を得るために、効率的な収束率で
$$
J(\phi_k) \xrightarrow[k \to \infty]{} \sup_\phi J(\phi),
$$

を達成するためには、適切なノルム$\|\cdot\|_\mathcal{H}$を選ぶことが重要です。ノルムが弱すぎると、アルゴリズムは不安定になり収束しない可能性があります。一方、ノルムが強すぎると、各ステップでほとんど変化が起こらず、アルゴリズムは収束が遅くなります。最適化の基盤の1つである以下の定理は、これらの競合する考慮事項をバランス良く取る方法を説明しています。

{\color{teal}
\begin{thm}
    \label{thm:chose norm}
    $J: \mathcal{H} \rightarrow \mathbb{R}$ を2階フレシェ微分可能な凹関数であり、最大化子 $\phi^*$ を持つとする。
    以下の条件がすべての $\phi, h \in \mathcal{H}$ に対して成り立つとき,$J$ は「$1$-$smooth$」と呼ばれる:
    \begin{equation}
        \label{eq:1-smooth}
        \delta^2 J(\phi)(h, h) \leq \|h\|_\mathcal{H}^2.
    \end{equation}
    $J$が$1$-$smooth$のとき、
    勾配上昇法 
    $$
        \phi_{k+1} = \phi_k + \nabla_\mathcal{H} J(\phi_k)
    $$
    を初期点 $\phi_0$ から開始すると、次の上昇特性(\ref{eq:ascent})を満たし、また収束率(\ref{eq:convergence})を持つ：
    \begin{equation}
        \label{eq:ascent}
        J(\phi_{k+1}) \geq J(\phi_k) + \frac{1}{2}\|\nabla_\mathcal{H} J(\phi_k)\|_\mathcal{H}^2,
    \end{equation}
    \begin{equation}
        \label{eq:convergence}
        J(\phi^*) - J(\phi_k) \leq \frac{\|\phi^* - \phi_0\|_\mathcal{H}^2}{2k}.
    \end{equation}
\end{thm}
}

定理 \ref{thm:chose norm} から、ノルム $\|\cdot\|_\mathcal{H}$ を弱めるか強めるかという競合する要素が再び現れます。
より強いノルムは式 (\ref{eq:1-smooth}) を満たしやすくしますが、より弱いノルムは収束率 (\ref{eq:convergence}) を改善します。
これらの考慮事項をまとめると、式 (\ref{eq:1-smooth}) を満たす限りできるだけ弱いノルムを選ぶのが最適であることが分かります。


\subsubsection{Sobolev norm}

$\Omega$を$\mathbb{R}^d$の開有界凸部分集合とする。
勾配上昇法は、Sobolev空間$H^1(\Omega)$に基づいたノルム$H$を使用します。
$\Theta_1 > 0$ and $\Theta_2 > 0$を定数として、次のようにノルムを定義します。
\begin{equation}
    \label{eq:norm}
    \|h\|_H^2 = \int_{\Omega} \Theta_2 |\nabla h(x)|^2 + \Theta_1 |h(x)|^2 \, dx.
\end{equation}

$\Theta_1$や$\Theta_2$の具体的な値は、最大化される関数によって異なる
（例えば、セクション3の定理3.3を参照してください）。
{\color{red}
多くの場合、$\Theta_1$と$\Theta_2$を大きく異なる値に設定することが最適です。
}
そのため、これらのパラメータを単一のステップサイズの値に縮小しないほうがよい。
次の補題では、この内積に関する勾配の計算方法が示されています。

\begin{lem}
    $F = F(\varphi)$ がフレシェ微分可能な汎関数であり、任意の $\phi$ に対して、任意の点 $h$ で評価される第1変分 $\delta F(\phi)$ が関数 $f_{\phi}$ に対する積分として表されるとします。
    つまり、
    \[
        \delta F(\phi)(h) = \int_\Omega h(x) f_{\phi}(x) dx
    \]

とします。式 (\ref{eq:norm}) で $\| \cdot \|_H$ を定義します。すると、$F$ の $H$-勾配は次のように表されます。
\[
    \nabla_H F(\phi) = (\Theta_1 \mathrm{Id} - \Theta_2 \Delta)^{-1} f_{\phi}
\]

ここで、$\mathrm{Id}$ は単位作用素、$\Delta$ はラプラス作用素であり、ゼロノイマン境界条件を伴って考えます。
\end{lem}


\begin{proof}
    固定した$\phi$に対して、楕円型方程式 
    \begin{equation}
        \begin{cases}
            (\Theta_1 \text{Id} - \Theta_2 \Delta)g  = f_\phi  & \text{in} \, \Omega \\
            n \cdot \nabla g = 0 & \text{on} \, \partial \Omega 
        \end{cases}
    \end{equation}
    
    の一意な解を考えます。ただし$n(x)$ は $\Omega$ の境界上での単位法線ベクトル。すると、以下の等式の連鎖が得られます：

\begin{align*}
    \delta F(\phi)(h)   &= \int_\Omega h(x) f_\phi(x) \, dx \\
                        &= \int_\Omega h(x)(\Theta_1 \text{Id} - \Theta_2 \Delta)g(x) \, dx \\
                        &= \int_\Omega h(x) \Theta_1 g(x) \, dx  - \int_\Omega h(x) \Theta_2 \Delta g(x) \, dx \\
                        &= \int_\Omega \Theta_1 h(x)g(x) \, dx - \int_\Omega \Theta_2 h(x) \Delta g(x) \, dx \\
                        &= \int_\Omega \Theta_1 h(x)g(x) \, dx - \left[h(x) \Theta_2 \nabla g(x) \cdot n \right]_{\partial \Omega}+ \int_\Omega \Theta_2 \nabla h(x) \cdot \nabla g(x) \, dx \quad \text{(部分積分・ガウスの発散定理)} \\
                        &= \int_\Omega \Theta_1 h(x)g(x) \, dx + \int_\Omega \Theta_2 \nabla h(x) \cdot \nabla g(x) \, dx\\
                        &= \langle h, g \rangle_H.
\end{align*}

これにより、$g$が$F$のH-勾配であることが示されます。$(g = \nabla_H F(\phi) = (\Theta_1 \text{Id} - \Theta_2\Delta)^{-1}f_\phi)$

\end{proof}

{\color{red}
上記の結果は次のように言い換えることができます：
$F$の$H$-勾配は、$\delta F$を逆演算子$(\Theta_1 \text{Id} - \Theta_2\Delta)^{-1}$で「事前調整」することによって得られます。

つまり、$F$の$H$-勾配を計算する場合、$\delta F$を直接適用する代わりに、まず逆演算子$(\Theta_1 \text{Id} - \Theta_2\Delta)^{-1}$を$\delta F$に適用します。
この逆演算子を適用するプロセスは、「事前調整」と呼ばれ、収束特性を改善し、$H$-勾配の計算を効率化するために、$\delta F$を修正する役割を果たします。
すなわち、
\begin{align*}
    f_\phi  &= (\Theta_1 \text{Id} - \Theta_2 \Delta)g\\
            &= (\Theta_1 \text{Id} - \Theta_2 \Delta)\nabla_H F(\phi)\\
\end{align*}
を用いると、
\begin{align*}
    \delta F(\phi)(h)   &= \int_\Omega h(x) f_\phi(x) \, dx \\
                        &= \int_\Omega h(x)(\Theta_1 \text{Id} - \Theta_2 \Delta)g(x) \, dx \\
                        &= \int_\Omega h(x)(\Theta_1 \text{Id} - \Theta_2 \Delta)\nabla_H F(\phi)(x) \, dx \\
\end{align*}
となる。よって、
\begin{align}
    \label{eq:nabla,delta}
    \begin{split}
    \delta F(\phi)  &= (\Theta_1 \text{Id} - \Theta_2 \Delta)\nabla_H F(\phi)(x),\\
    \nabla_H F(\phi) &= (\Theta_1 \text{Id} - \Theta_2 \Delta)^{-1} \delta F(\phi).
    \end{split}
\end{align}
となる。ただし、$\delta F(\phi)$は(\ref{eq:delta J}),(\ref{eq:delta I})を参照。

}


\section{THE BACK-AND-FORTH METHOD}

私たちの目標は、興味深いエネルギー関数$U$の大きなクラスに対して、JKOスキームを効率的に解くアルゴリズムを開発することです。
第3.1節では、$U$が$\rho$に関して凸である場合を考えます。
この場合、JKOスキームには等価な双対問題があり、[21]からのback-and-forthメソッドの改良版を使用して解決します。
第3.2節では、以下の形式の凸エネルギーに対して、アルゴリズムが適切に重み付けられた$H^1$空間で勾配安定性を持つことを示します。
\[
    U(\rho) = \int_\Omega u_m(\rho(x)) + V(x)\rho(x) \, dx
\]
ここで、$V: \Omega \to [0, + \infty] $は固定された関数であり、
\begin{equation}
    \label{eq:u_m}
    u_m(\rho) = \begin{cases} \frac{\gamma}{m - 1}(\rho^m - \rho) & \text{if } \rho \geq 0 \\ +\infty & \text{otherwise} \end{cases}
\end{equation}
となります。ただし、定数\(\gamma > 0\)と\(m > 1\)が存在します。
また、$m \to 1$および$m \to \infty$の2つの極限の場合も考慮します。
私たちの解析はより一般的な汎関数に拡張することも可能ですが、わかりやすさのために上記の特殊なケースに焦点を当てています。
凸エネルギー関数$U$のメソッドを開発した後、第3.3節では非凸な$U$に対してアルゴリズムを一般化する方法を示します。

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{The back-and-forth method for convex $U$}

JKOスキームを反復するためには、任意の非負密度$\mu \in L^1(\Omega)$に対して、以下の一般化最適輸送（GOT）問題を解くことが必要です:
\begin{equation}
\label{eq:GOT}
    \rho_* = \underset{\rho \in L^1(\Omega)} {\operatorname{argmin}}\,  U(\rho) + \frac{1}{2\tau}W_2(\rho,\mu),
\end{equation}

ここで、$U$は凸である場合には、一般化最適輸送問題は双対性を持つことがSection \ref{sect:Convex duality}で示されました（Thm. \ref{thm: duality}）。
具体的には、$U$が凸であるとき、一般化最適輸送問題は次のような対双対関係にあります。
$$
    \inf_{\rho \in L^1(\Omega)} U(\rho) + \frac{1}{2 \tau} W^2_2(\rho, \mu) = \sup_\phi J(\phi) = \sup_\psi I (\psi)
$$
$I$と$J$は次のように定義されます。


\begin{equation}
    \label{eq:J2}
    J(\phi):= \int_{\Omega} \phi^c(x) \mu(x) \,dx(x) - U^*(- \phi)
\end{equation}

\begin{equation}
    \label{eq:I2}
    I(\psi):= \int_{\Omega} \psi(x) \mu(x) \,dx(x) - U^*(- \psi^{c})
\end{equation}

さらに、問題（\ref{eq:GOT}）の最小化解$\rho_*$は、最大化解$\phi_*, \psi_*$と関連しており、次の関係が成り立ちます。

\begin{equation}
    \label{eq:maxmin}
    \rho_* = T_{\phi_* \#} \mu, \quad \rho_* \in \delta U^*(- \phi_*), \quad \phi^c_* = \psi_*
\end{equation}

$I$と$J$は制約のない凹関数汎関数です（Prop. \ref{prop:functional}を参照）。
したがって、いずれかの関数の最大化解を標準的な勾配上昇法で見つけることができます。
一方、単に$I$または$J$だけを使用することは問題の対称性を破壊します。
したがって、関数のいずれかにだけ焦点を当てるのではなく、back-and-forthメソッドでは$I$とs$J$の交互の勾配上昇ステップが行われます。
$I$と$J$は異なる変数を使用していますが、$c$-変換を使用することで$\psi$と$\phi$の間を切り替えることができます。
[21]で指摘されているように、$I$と$J$による交互のステップは、標準的な勾配上昇法を超えた方法の収束速度を大幅に加速させます。\\

今、問題(\ref{eq:GOT})の双対最大化子$(\phi_*, \psi_*)$を見つけるためのアプローチを紹介します。
この方法は、アルゴリズム2に概要が示されており、以下の2つの主要なアイデアに基づいています:

\begin{enumerate}
    \item Back-and-Forth Update Scheme:$I$と$J$における勾配上昇ステップを交互に繰り返す。
    \item $H^1$-型ノルム$H$における勾配上昇ステップは以下のようになる(参考:(\ref{eq:nabla,delta})):
    {\color{red}
        \begin{equation*}
            \nabla_H J(\phi) = (\Theta_1 \text{Id} - \Theta_2 \Delta)^{-1} \left[\delta U^*(- \phi)-  T_{\phi \#} \mu \right], \\
        \end{equation*}
        \begin{equation*}
            \nabla_H I(\psi) = (\Theta_1 \text{Id} - \Theta_2 \Delta)^{-1} \left[\mu - T_{\psi \#} (\delta U^*(\psi^c))\right].
        \end{equation*}
    }
\end{enumerate}


\begin{algorithm}[tb]
    \caption{The back-and-forth scheme for solving(\ref{eq:J2}) and (\ref{eq:I2})}
    \label{algo:baf scheme}
    \begin{algorithmic}
    \State{Given $\mu$ and $\phi_0$, iterate:}
    \State{
        \begin{align*}
            \phi_{k + \frac{1}{2}} &= \phi_k + \nabla_H J(\phi_k)\\
            \psi_{k + \frac{1}{2}} &= (\phi_{k + \frac{1}{2}})^c\\
            \psi_{k + 1} &= \psi_{k + \frac{1}{2}} + \nabla_H I(\psi_{k + \frac{1}{2}})\\
            \phi_{k + 1} &= (\psi_{k + 1})^c
        \end{align*}
    }
    \end{algorithmic}
\end{algorithm}

\begin{algorithm}[tb]
    \caption{Running the JKO scheme}
    \begin{algorithmic}
    \State{Given initial data $\rho^{(0)}$, initialize $\phi^{(0)} = \delta U(\rho^{(0)}).$}
    \For{$n = 0 \, \ldots \, N$}
        \State{$\phi^{(n+1)} \leftarrow \,$ Run Algorithm \ref{algo:baf scheme} with $\mu = \rho^{(n)}$ and $\phi_0 = \phi^{(n)}$,}
        \State{$\rho^{(n+1)} = \delta U^*(- \phi^{(n+1)})$.}
    \EndFor
    \end{algorithmic}
\end{algorithm}


Algorithm \ref{algo:baf scheme}の各ステップが関数的な値$J$と$I$を増加させることを示すことが最終目標です。
Lemma \ref{lem:c-transform}およびLemma \ref{lem:monotone increasing}のおかげで、次の関係が容易に確認できます：

\[
    J(\phi_{k + \frac{1}{2}}) \leq I((\phi_{k + \frac{1}{2}})^c), \quad I(\psi_{k+1}) \leq J((\psi_{k+1})^c). 
\]

したがって、$\phi$と$\psi$の変数を交互に切り替える交互ステップは、双対問題の値のみを増加させることが分かります。
ただし、勾配ステップ\(\phi_{k + \frac{1}{2}} = \phi_k + \nabla_H J(\phi_k)\)および\(\psi_{k+1} = \psi_{k + \frac{1}{2}} + \nabla_H I(\psi_{k + \frac{1}{2}})\)がそれぞれJとIの値を増加させることを示すには、より詳細な解析が必要です。
この解析はSection \ref{sect $H^1$ gradient ascent}の主な焦点となります。
$H^1$プリコンディショナー\((\Theta_1 \text{Id}-\Theta_2\Delta)^{-1}\)によって提供される強化された安定性が、勾配ステップが昇方向の性質を持つことを保証するために重要です。

{\color{red}
$I$および$J$の双対問題が十分な精度で解かれた後、(\ref{eq:GOT})式における最適密度\(\rho_*\)は(\ref{eq:maxmin})式の双対関係を通じて復元することができます。
非圧縮流などの特定の例では、部分微分\(\delta U^*\)は多価となることがあります。
この場合、\(\rho_* \in \delta U^*(\phi_*)\)という関係では\(\rho_*\)が一意に定まりません。
ただし、実際には、\(\delta U^*\)は通常、\(\phi_*\)の測度$0$の single level set上でのみ多価となります。
そのため、数値的な目的のためには、単に\(\rho_* = \delta U^*(- \phi_*)\)と同一視することができます。
この方法で\(\rho_*\)を回復することは、プッシュフォワードの関係\(\rho_* = T_{\phi_* \# }\mu\)とは異なり、\(\varphi^*\)の数値微分を計算する必要がないため有利です。
}
これらの結果を組み合わせることで、JKOスキームの進化のためのアルゴリズムが得られる。

\subsection{$H^1$ gradient ascent}
\label{sect $H^1$ gradient ascent}

勾配上昇ステップの安定性を確保するために、$I$と$J$の勾配は$H^1$ Sobolevノルムに基づく距離で計算する。
$\Theta_1 > 0, \Theta_2 > 0$の$2$つの定数を与えられた場合、Hilbertノルム$H$を以下のように定義します:
\begin{equation}
    \label{eq:Hilbertノルム}
    \|h\|_H^2 = \int_\Omega \Theta_2 |\nabla h(x)|^2 + \Theta_1 |h(x)|^2 \, dx.
\end{equation}

The back-and-forth scheme の主なステップは、$H$ノルムでの以下の勾配上昇ステップである:
\[
    \phi_{k + \frac{1}{2}} = \phi_k + \nabla_H J(\phi_k),
\]
\[
    \psi_{k+1} = \psi_{k + \frac{1}{2}} \nabla_H I(\psi_{k + \frac{1}{2}}).
\]
この方法の収束性を得るために、これらのステップが凹関数$J$および$I$の値を増加させることを望みます。
以下の勾配上昇性質

\[
    J(\phi_{k + \frac{1}{2}}) - J(\phi_k) \geq \frac{1}{2}\|\nabla_H J(\phi_k)\|_H^2,
\]

\[
    I(\psi_{k+1}) - I(\psi_{k + \frac{1}{2}}) \geq \frac{1}{2}\|\nabla_H I(\psi_{k + \frac{1}{2}})\|_H^2,
\]

は、Hessianの制約

\begin{align}
    \label{eq:Hessian}
    \begin{split}
        \delta^2 J(\phi)(h,h) \leq \|h\|_H^2,\\
        \delta^2 I(\psi)(h,h) \leq \|h\|_H^2,
    \end{split}
\end{align}
が満たされている場合に得られます（詳細は\ref{sect: Gradient ascent method}節のThm. \ref{thm:chose norm}を参照）。
式(\ref{eq:Hessian})が成り立つとき、$I$と$J$は$H$に関して「$1$-smooth」と言われます。\\


この小節の残りの部分は、式（\ref{eq:Hessian}）のような不等式を得ることに充てます。
具体的には、式（\ref{eq:Hilbertノルム}）の定数$\Theta_1$と$\Theta_2$をどのように選ぶかを示し、$U$が以下の形式を持つ場合に、$\phi$と$\psi$の正則性の仮定のもとで$I$と$J$が$1$-smoothであることを保証します。

\begin{equation}
    \label{eq:U}
    U(\rho) = \int_\Omega u_m(\rho(x)) \, dx + \int_\Omega V(x) \rho(x) \, dx,
\end{equation}

ここで、$u_m$は式（\ref{eq:u_m}）で定義され、$V : \Omega \to [0, +\infty]$は与えられた関数です。

{\color{red}
重要なことは、$\Theta_1$と$\Theta_2$の上界を与えることで、それらはデータから効率的に計算することができる。
$\Theta_1$と$\Theta_2$のきつい上界を得ることは重要である。なぜなら、それらは基本的にアルゴリズムのステップサイズを制御するからである（$\Theta_1$と$\Theta_2$が小さい値の場合、大きな勾配ステップに対応する）。
\ref{sect:Concave gradient ascent}節で説明したように、(\ref{eq:Hessian})が成り立つ最小の$\Theta_1$と$\Theta_2$の値を選ぶことが最適。この解析は実用的であり、数値実験も私たちの主張を裏付けている。
具体的な値は、定理\ref{thm:q-smoothness of J}と定理\ref{thm:theta1,2 bounds}を参照することで得られる。
}

\subsubsection{Hessian bound analysis}

$I(\psi)$と$J(\phi)$の Hessian の境界解析はほぼ同じである。
したがって、私たちは主に$J$の解析に焦点を当て、後で$I$に対する同様のアプローチを説明する。
$J(\phi) = \int \phi^c\mu - U^*(- \phi)$ の Hessian 境界を得るために、$c$-transformの項 
\begin{equation}
    \label{def:F}
    F(\phi) := \int_\Omega \phi^c(x)\mu(x) \, dx
\end{equation}
の境界を導出し、次に内部エネルギー項$U^*(\phi)$の境界を得る。
まず, $\delta^2 F(\phi)$の式を示すことで、点$\phi$における$F$の Hessian が$c$-convexのであることを示す。

\begin{lem}[Hessian bounds on the c-transform]
    \label{lem:Hessian bounds on the c-transform}
    \hyperlink{proof:lem:Hessian bounds on the c-transform}{(Proof)}
    関数Fを(\ref{def:F})で定義します。
    もし$\phi$が$c$-凸関数であるならば、$\phi$における$F$の Hessian は次のように表されます:
    $$
    \delta^2 F(\phi)(h,h) = -\tau \int_\Omega \nabla h(x) \cdot \text{cof}\, (I_{d \times d} + \tau D^2 \phi(y)) \nabla h(y) \mu(y - \tau \nabla \phi(y))\, dy.
    $$
    ここで、$\text{cof}\, (I_{d \times d} + \tau D^2 \phi(y))$は $I_{d \times d} + \tau D^2 \phi(y)$ の余因子行列を示しています。
    さらに、$\forall y \in \Omega$に対して、$I_{d \times d} + \tau D^2 \phi(y)$ の固有値が上限$\Lambda$で制約されている場合、次の境界が成り立つ: 
    {\color{red}
        \begin{equation}
            \label{eq:Hessian upper bounds}
            \delta^2 F(\phi)(h,h) \leq \tau \|\mu\|_{L^\infty} \Lambda^{d-1} \|\nabla h\|_{L^2}^2.
        \end{equation}
    }
    
\end{lem}

\begin{proof}
    \hyperlink{proof:lem:Hessian bounds on the c-transform}{Appendix}
\end{proof}

式(\ref{eq:Hessian upper bounds})の境界を理解するために、正定値対称行列 $M \in \mathbb{R}^{d \times d}$（固有値 $\{\lambda_1,...,\lambda_d\}$ を持つ）を考える。
$M$ の余因子行列 cof$(M)$ の固有値は $\{\frac{\det(M)}{\lambda_1},..., \frac{\det(M)}{\lambda_d}\}$ となる。
これにより、$\Lambda^{d-1}$ の $d-1$ 次のスケーリングが得られます。
{\color{teal}
さらに、$\Lambda$ 自体の意味をより理解するために、最適な双対変数 $\rho^*$ が 
{\color{red}
\begin{align*}
    \rho^* = T_{\varphi_* \#} \mu  &= \mu (T^{-1}_\varphi(x)) |\det \nabla T (T^{-1}(x))|^{-1}\\
    &= \mu(y - \tau \nabla \varphi_*(y)) \det(I_{d \times d} - \tau D^2 \varphi(y))
\end{align*}
}

で与えられることを思い出す。(Thm.\ref{thm: duality})(\ref{eq:pushforward Tphi})(\ref{eq:pushforward Tpsi})
したがって、$I_{d \times d} - \tau D^2 \phi$ の固有値は、$\rho^*$ の質量が $\mu$ に対してどれだけ集中しているかを大まかに測定します。
{\color{red}
$\rho^*$ と $\mu$ の差が $\tau$ のオーダーであることが期待されるため、$\Lambda$ は1に近い値になることが合理的です。
}
}

\vspace\baselineskip 

内部エネルギー項 $U^*(\phi)$ の Hessian の上界を求めることに注目する。
$U$が形式(\ref{eq:U})を取る場合、その凸共役は次のように書ける:
\[
    U^*_m(- \phi) = \int u_m^*(- \phi(x) - V(x)) \, dx,
\]
ただし,
$$
    u^*_m(p) = \gamma^{- \frac{1}{m - 1}} \left( \frac{(m - 1)p + \gamma}{m}\right)_+^{\frac{m}{m-1}}
$$
であり、$(\cdot)_+ = \max(\cdot, 0)$ です。
このとき、$U^*$の Hessian は次のように表される：
\begin{equation}
    \label{eq:delta^2U}
    \delta^2 U^*(\phi)(h, h) = \int_\Omega (u_m^*)^{\prime \prime}(\phi(x) - V(x))|h(x)|^2 \, dx.
\end{equation}
\[
    - \delta^2 U^*(\phi)(h, h) = \int_\Omega (u_m^*)^{\prime \prime}(- \phi(x) + V(x))|h(x)|^2 \, dx.
\]

ここで $1 \leq m \leq 2$ の場合、上界は明らかであり、$(u_m^*)^{\prime \prime}(p)$ は $p$ に関して増加することが分かっています。
したがって、この場合は次のようになります：
\[
    - \delta U(- \phi)(h, h) = \int_\Omega (u_m^*)^{\prime \prime}(\phi(x) + V(x))|h(x)|^2 \, dx \leq B\|h\|_{L^2(\Omega)}^2,
\]
ここで $B = \sup_{x\in\Omega}(u_m^*)^{\prime \prime}(\phi(x) - V(x))$ です。
[20]で示されているように、関数 $J$ の最大化元 $\phi^*$ は最大型原理を満たすことが分かっており、つまり
\[
    \phi_*(x) \leq M := \sup_{x \in \Omega} \delta U(\mu)(x).
\]
したがって、アルゴリズム全体で $\phi$ の上限が $M$ であることが自然である
（勾配ステップは、最も集中している領域で圧力を拡散させる傾向があります）。
全ての点で、$V(x) \geq 0$ であると仮定すると、次のようになる:
\[
    - \delta^2 U(- \phi)(h, h) \leq (u_m^*)^{\prime \prime}(M)\|h\|_{L^2(\Omega)}^2.
\]

\vspace\baselineskip 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%6/11
圧力に対する前述の最大原理 $\phi(x) \leq M$ は、密度を圧力の代わりに用いた上界の表現にも利用することができます。
実際に、以下のようになります：
\[
    \rho(x) = (u_m^*)^\prime (\phi(x) + V(x)) \leq (u_m^*)^\prime(\phi(x)) \leq (u_m^*)^\prime(M).
\]
したがって、量
\begin{equation}
    \label{dfn:rho}
    \rho_{\max} := (u_m^*)^\prime(M)    
\end{equation}
は、密度の自然な上界となります。
さらに、
$(u^*_m)^{\prime \prime} (M) = (u^*_m)^{\prime \prime}(u^\prime_m(\rho_{\max})） = u_m^{\prime \prime}(\rho_{\max})^{-1}$
と書くことで、
\[
    \delta^2 U^*(\phi)(h, h) \leq u_m^{\prime\prime}(\rho_{\max})^{-1} \|h\|_{L^2(\Omega)}^2.
\]
となります。\\

\begin{align*}
    (u^*)^{\prime}(p) &= \left(\gamma^{- \frac{1}{m - 1}} \left( \frac{(m - 1)p + \gamma}{m}\right)_+^{\frac{m}{m-1}}\right)^{\prime}
                        = \gamma^{- \frac{1}{m - 1}} \frac{m}{m - 1} \left( \frac{(m - 1)p + \gamma}{m}\right)^{\frac{1}{m-1}}\left( \frac{(m - 1)p + \gamma}{m}\right)^{\prime}\\
                        &= \gamma^{- \frac{1}{m - 1}} \left( \frac{(m - 1)p + \gamma}{m}\right)^{\frac{1}{m-1}}
\end{align*}
    
\begin{align*}
    u_m(\rho) &= \frac{\gamma}{m - 1}(\rho^m - \rho)\\
    u_m^{\prime}(\rho) &= \frac{\gamma}{m - 1}(m \rho^{m - 1} - 1)\\
    u_m^{\prime\prime}(\rho) &= \gamma m \rho^{m - 2}\\
    (u_m^{\prime\prime}(\rho_{max}))^{-1} &= \frac{1}{\gamma m}(\rho_{max})^{2 - m}\\
\end{align*}

$m > 2$ の場合はかなり複雑です。

$m > 2$ の場合、$(u_m^*)^{\prime\prime}$ は$0$で特異点を持ちます。
したがって、積分項は $\phi(x) = V(x)$ の周辺で非有界となる場合があります。
この場合、(\ref{eq:delta^2U})を $h$ の $L^2$ ノルムで制約することはできません。これをより良く理解するために、本論文で考慮する最も困難なモデルである不圧縮極限 $m \to \infty$ に焦点を当てる。
$m \to \infty$ の場合、エネルギー関数 $u_m$ は密度値に対する厳しい上限制約を表しており、つまり
\[
    u_\infty(\rho) = \begin{cases}
        0 & \text{if } 0 \leq \rho \leq 1, \\
        +\infty & \text{otherwise}.
    \end{cases}
\]
となります。したがって、双対エネルギー $u_\infty^*$ は次のようになります：
\[
    u_\infty^*(p) = \begin{cases}
        0 & \text{if } p < 0, \\ 
        p & \text{if } p \geq 0. 
    \end{cases}
\]
ここで、$u_\infty^*$ は $u_\infty$ よりもはるかに正則性が高く、例えば $u_\infty^*$ は実数全体$(\mathbb{R})$で連続ですが、$u_\infty$ は $0$ と $1$ において不連続。
これは、双対な量を使用する利点を再度示している。
ただし、$u_\infty^*$ は明らかに凸的な意味で滑らかではなく、$0$ において導関数にジャンプがある。
実際に $(u_\infty^*)^{\prime\prime} = \delta_0$ となる。
ここで、$\delta_0$ は $0$ におけるDiracのデルタ関数を表す。\\


\(U^*\)が滑らかではない\(u^*_\infty\)から構築されている場合でも、小さな集合にのみ特異性が存在する場合には、\(U^*\)のヘッセ行列を制約することができます。
具体的には、\(| \nabla \phi(x) - \nabla V(x) |\)が表面\(\{\phi = V\}\)上で$0$から離れているという仮定する。
つまり、定数\(\Gamma_0 > 0\)が存在し、以下の条件を満たすとする。

\[
    \sup_{\{x \in \Omega: \phi(x) = V(x)\}} \frac{1}{|\nabla \phi(x) - \nabla V(x)|} \leq \Gamma_0
\]

（これは、\(\{\phi = V\}\)が低次元の集合であることを定量的に表現しています）。このとき、共面積の公式を使用して、式(\ref{eq:delta^2U})を以下のように書き直すことができます。

\begin{align}
    \label{eq:delta^2U surface measure}
    \begin{split}
        -\delta^2 U^*(\phi)(h, h)   &= \int_{\mathbb{R}}(u^*_\infty)^{\prime\prime}(\alpha) \int_{\{x \in \Omega: \phi(x) - V(x) = \alpha\}}  \frac{|h(x)|^2}{|\nabla \phi(x) - \nabla V(x) |} \, ds(x)\, d \alpha \\
                                    &= \int_{\{\phi(x) = V(x)\}} \frac{|h(x)|^2}{|\nabla \phi(x) - \nabla V(x)|} \, ds(x)\\
                                    &= \Gamma_0 \int_{\{\phi(x) = V(x)\}} | h(x) |^2 \, ds(x),
    \end{split}
\end{align}


ここで、\(ds\)は通常の面積測度です。面積にわたる積分が行われるため、(\ref{eq:delta^2U surface measure})の右辺を\(\|h\|_{L^2}\)の形で制約することはできません。
ただし、PDE理論の\textit{trace inequalities}を使用して、表面積分をより高次の導関数を含む体積積分で制約することができます[11]（これは基本的にはストークスの定理の不等号版と見なすことができます）。
より具体的には、定数\(C_1\)、\(C_2\)が\(\{\phi = V\}\)に依存しますが、\(h\)に依存しないようなトレース不等式が存在し、
\[
    \int_{\{\phi = V\}} |h(x)|^2 ds(x) \leq C_2 \| \nabla h \|^2_{L^2(\Omega)} + C_1 \| h \|^2_{L^2(\Omega)}.
\]
が成り立ちます。
ここから、\(\Theta_1 \geq C_1 \Gamma_0\)、\(\Theta_2 \geq C_2 \Gamma_0\)を選べば、以下の式から分かるように\(U^*\)が\(H\)-smoothであることが直ちに導かれる:
\[
    \Gamma_0 \int_{\phi = V} |h(x)|^2 \, ds(x) \leq \|h\|^2_{L^2(\Omega)}
\]

\vspace\baselineskip
%%%%%%%%%%%%%

最も特異な場合である\(m \to \infty\)の場合にヘッセ行列の制約を得る方法を見てきたので、\(2 < m < \infty\)の場合に戻りましょう。
この場合、\(u^*_m\)の二階導関数\(u^*_m(p)^{\prime\prime}\)は、\(p < 0\)では、\(p = 0\)で特異、\(p > 0\)で減少する特性を持っています。
したがって、ある値\(\lambda > 0\)を選び、
\[
    A_\lambda = \{x \in \Omega : 0 \leq \phi(x) - V(x) \leq \lambda\},
\]
とすると、次の制約が直ちに得られます。
\[
    \delta^2 U(\phi)(h,h) \leq (u^*_m)^{\prime\prime}(\lambda) \|h\|_{L^2(\Omega)} + \int_{A_\lambda} (u^*_m)^{\prime\prime}(\phi(x) - V(x)) |h(x)|^2 \,dx.
\]
第二項を評価するために、\(m = \infty\)の場合と同様の手法を用います。
任意の\(\alpha \in \mathbb{R}\)に対して、\(\{\phi - V = \alpha\} = \{x \in \Omega : \phi(x) - V(x) = \alpha\}\)とする。
定数\(\Gamma_\lambda\)とトレース不等式の定数\(C_1(\alpha)\)、\(C_2(\alpha)\)が
\begin{equation}
    \label{dfn:gamma_lambda}
    \sup_{x \in A_\lambda} \frac{1}{|\nabla \phi(x) - \nabla V(x)|} \leq \Gamma_\lambda
\end{equation}
および
\begin{equation}
    \int_{\{\phi - V = \alpha\}} |h(x)|^2 ds(x) \leq C_2(\alpha) \| \nabla h \|^2_{L^2(\Omega)} + C_1(\alpha) \| h \|^2_{L^2(\Omega)},
\end{equation}
の条件を満たす限り、上記の議論を再現することができます。
共面積の公式とトレース不等式を組み合わせることで、次の一連の不等式を得ます。

\begin{align*}
    \int_{A_\lambda}(u^*_m)^{\prime\prime}(\phi(x) - V(x)) |h(x)|^2 dx  &\leq \Gamma_\lambda \int_{0}^{\lambda} (u^*_m)^{\prime\prime}(\alpha) \int_{\{\phi - V = \alpha\}} |h(x)|^2 ds(x) d\alpha \\
                                                                        &\leq (u^*_m)^\prime (\lambda) \Gamma_\lambda \left( C_{2, \lambda} \| \nabla h \|^2_{L^2(\Omega)} + C_{1, \lambda} \| h \|^2_{L^2(\Omega)}\right),
\end{align*}
ここで
\begin{equation}
    \label{dfn:C_ilambda}
    C_i(\lambda) = \max_{0 \leq \alpha \leq \lambda} C_i(\alpha)
\end{equation}
です。
したがって、以下の$\Theta_1,\Theta_2$を選ぶことで、 \(-\delta^2 U^*(h,h)\)は\(\| h \|^2_H\)で抑えられる。

\[
    \Theta_1 \geq (u^*_m)^{\prime\prime}(\lambda) + (u^*_m)^{\prime}(\lambda) \Gamma_\lambda C_{1, \lambda},
\]

\[
    \Theta_2 \geq (u^*_m)^{\prime}(\lambda) \Gamma_\lambda C_{2, \lambda}
\]
ここで、\(\lambda\)の正確なな値を自由に選択することができる。

上記の計算結果をまとめた補題が以下である。

\begin{lem}[Hessian bound on the internal energy]
    \label{lem:Hessian bound on the internal energy}
    (\ref{dfn:rho}),(\ref{dfn:gamma_lambda})(\ref{dfn:C_ilambda}),によって$\rho_{\max},\Gamma_\lambda, C_{i,\lambda}$を定義します。

    \begin{enumerate}
        \item Case $1 \leq m \leq 2$. 以下の制約が成り立つ:
            \[
                - \delta^2 U^*(- \phi)(h, h) \leq \frac{1}{\gamma m}(\rho_{\max})^{2-m} \|h\|_{L^2}^2 
            \]
        \item Case $2 \leq m \leq \infty$. 任意の$\lambda > 0$に対して、以下の制約が成り立つ:
            \[
                \delta^2 U^*(\phi)(h, h) \leq (\gamma m^\prime)^{1 - m^\prime} C_{2,\lambda} \Gamma_\lambda \| \nabla h \|_{L^2}^2 + (\gamma m^\prime)^{1 - m^\prime} \left(C_{1,\lambda} \Gamma_\lambda \lambda^{m^\prime - 1} + (m^\prime - 1) \lambda^{m^\prime - 2}\right) \|h\|_{L^2}^2
            \]
            ただし,\(m^\prime = \frac{m}{m - 1}\)である.
        \item Case $m = \infty$. 以下の制約が成り立つ:
            \[
                \delta^2 U^*(\phi)(h,h) \leq C_{2,0} \Gamma_0 \| \nabla h \|_{L^2}^2 + C_{1,0} \Gamma_0 \|h\|_{L^2}^2
            \]
    \end{enumerate}
\end{lem}

補題\ref{lem:Hessian bounds on the c-transform}および\ref{lem:Hessian bound on the internal energy}を組み合わせることで、この節のメイン定理を直接得ることができます。


\begin{thm}[Jの1-smoothness]
    \label{thm:q-smoothness of J}
    $1 \le m \le \infty$ および $U(\rho) = \int_{\Omega} u_m(\rho(x)) + V(x)\rho(x)\, dx$, ここで $u_m$ は (\ref{eq:u_m}) で定義される。
    このとき、$J(\phi) := \int_{\Omega} \phi^c(x) \mu(x)\, dx - U^*(- \phi)$ は、Hessianの上界 
    $$
        \delta ^2 J(\phi)(h,h) \leq \Theta_2 \| \nabla h\|^2_{L^2} + \Theta_1 \|h\|^2_{L^2}
    $$ 
    を満たします。ここで、$\Theta_1, \Theta_2 > 0$ は以下の表で与えられます。

    $m = 2$のとき
    \begin{align*}
        \delta^2 F(\phi)(h,h) + \delta^2 U^*(\phi)(h, h) &\leq \tau \|\mu\|_{L^\infty} \Lambda^{d-1} \|\nabla h\|_{L^2}^2 + \frac{1}{\gamma m}(\rho_{\max})^{2-m} \|h\|_{L^2}^2\\
        \delta^2 J(\varphi)(h, h)                        &\leq \tau \Lambda^{d-1} \|\mu\|_{L^\infty} \|\nabla h\|_{L^2}^2 + \frac{1}{2 \gamma} \|h\|_{L^2}^2
    \end{align*}

    \begin{table}[]
        \centering
        \caption{}
        \renewcommand{\arraystretch}{1.5}
        \label{table:theta-m}
        \begin{tabular}{|c|c|c|}
        \hline
        $m$ & $\Theta_1$ & $\Theta_2$ \\ 
        \hline \hline
        $m = 1$ & $\frac{\rho_{max}}{\gamma}$ & $\tau \Lambda^{d - 1}\|\mu \|_{L^\infty}$ \\ \hline
        $1 < m < 2$ & $\frac{{\rho_{max}}^{2 - m}}{\gamma m}$ & $\tau \Lambda^{d - 1}\|\mu \|_{L^\infty}$ \\ \hline
        $m = 2$ & $\frac{1}{2 \tau}$ & $\tau \Lambda^{d - 1}\|\mu \|_{L^\infty}$ \\ \hline
        $m > 2$ & ${(\gamma m^\prime)}^{1 - m^\prime} \left( \lambda^{m^\prime - 1} C_{1, \lambda} \Gamma_\lambda + \frac{m^\prime - 1}{\lambda^{2 - m^\prime}}\right)$ & ${(\gamma m^\prime)}^{1 - m^\prime} C_{2, \lambda} \Gamma_\lambda + \tau \Lambda^{d - 1}\|\mu \|_{L^\infty}$ \\ \hline
        $m = \infty$ & $C_{1, 0}\Gamma_0$ & $C_{2, 0} \Gamma_0 +  \tau \Lambda^{d - 1}\|\mu \|_{L^\infty}$ \\ \hline
        \end{tabular}
    \end{table}

    Lemma 3.1 と同様に、 $\Lambda$は $I_{d \times d} + \tau D^2\phi(y)$ の固有値の上界であり、$y$ に一様に依存します。
    さらに、$\lambda > 0$ は選択するパラメータであり、$\rho_{max}, \Gamma_{\lambda}, C_{i, \lambda}$は(\ref{dfn:rho}), (\ref{dfn:gamma_lambda}), (\ref{dfn:C_ilambda})で定義されている。
\end{thm}

$m > 2$ の場合に Theorem \ref{thm:q-smoothness of J} を使用するためには、$\Gamma_\lambda$ と $C_{i,\lambda}$ を計算できる必要があり、$m \in (2, \infty)$ の場合には $\lambda$ の値を選択する必要がある。
離散格子上では、$n$ 点において、全ての$\lambda$対して $\Gamma_\lambda$ を $O(n)$ の操作で簡単に計算することができる。
一方、単一の $\alpha$ の値に対して $C_1(\alpha)$ と $C_2(\alpha)$ を計算するには $O(n)$ の操作が必要（Sect. \ref{sect:Implementation details} を参照）。
したがって、$m = \infty$ の場合、定数を明示的に $O(n)$ の操作で計算することができる。
$2 < m < \infty$ の場合はより難しいです。なぜなら、$C_{i,\lambda} = \max_{0 \leq \alpha \leq \lambda} C_i(\alpha)$ を効率的に計算することはできないからです。
この困難を克服するために、通常は次の最小化問題を解くことで $\lambda$ を選択する。
\[
    \lambda^* = \underset{\lambda \geq 0} {\operatorname{argmin}} \, \, (\gamma m ^\prime)^{1 - m^\prime} \left(\lambda^{m^\prime - 1}\Gamma_\lambda C_1(0) + \frac{m^\prime - 1}{\lambda^{2-m^\prime}}\right),
\]
これにより、$\Theta_1$ を可能な限り小さくするための最適な $\lambda$ の選択肢の合理的な推定値が得られます。
次に、$\max_{0 \leq \alpha \leq \lambda^*} C_i(\alpha)$ を単に $C_i(0)$ と $C_i(\lambda^*)$ の最大値として推定します。
この方法は実際にはうまく機能するようです。\\

この議論をまとめるために、同様の解析が可能なもう一つの関数 $I$ に注目します。
まず、次のように定義します。
\[
    p(x) = (\psi^c - V)(T_{\psi^c}(x)),
\]
次に、$\lambda > 0$ に対して以下を定義します。
\begin{equation}
    \label{def:gamma}
    \tilde{\Gamma}_\lambda = \sup_{x: 0 \leq p(x) \leq \lambda} \frac{1}{|\nabla p(x)|}.
\end{equation}
最後に、定数$\tilde{C}_i(\alpha)$を以下のように定義する:
\[
    \int_{p = \alpha} |h(x)|^2 ds(x) \leq \tilde{C}_2(\alpha) \| \nabla h \|_{L^2}^2 + \tilde{C}_1(\alpha) \|h\|_{L^2}^2,
\]
ただし、
\begin{equation}
    \label{def:C}
    \tilde{C}_{i, \lambda} = \sup_{0 \leq \alpha \leq \lambda} \tilde{C}_i(\alpha). 
\end{equation}
とおく。
以上の結果に基づいて、関数$I$のHessian行列を制限する結果を述べることができます。


\begin{thm}
    \label{thm:theta1,2 bounds}
    $I(\psi) = \int_\Omega \psi(x)\mu(x)dx - U^*(- \psi^c)$ 、ここで $U(\rho) = \int_\Omega u_m(\rho(x)) + V(x)\rho(x)dx$ 、 $u_m$ は (\ref{eq:u_m}) で定義され、 $1 \leq m \leq \infty$ です。
    $I$の Hessian は以下のように表され,
    \[
        -\delta^2 I(\psi)(h,h) = \delta^2 U^*(\psi^c)(h \circ S_\psi,h \circ S_\psi) + \tau \int_\Omega \nabla h(x) \cdot \text{cof}(I_{d \times d} - \tau D^2\psi(x)) \nabla h(x) \delta U^*(\psi^c)(x - \tau \nabla\psi(x))dx.
    \]

    また次の境界を満たす:

    \[
        -\delta^2 I(\psi)(h,h) \leq \Theta_2\|\nabla h\|_{L^2}^2 + \Theta_1\|h\|_{L^2}^2.
    \]
    なお、 $\Theta_1$ と $\Theta_2 > 0$ は下表を参照。
    ここで、$\Lambda$ は $x$ に対して一様に $I_{d \times d} - \tau D^2\psi(x)$ の固有値の上界である。
    さらに、$\lambda > 0$ は選ぶパラメータであり、$\rho_{\max}$ は (\ref{dfn:rho}) で定義され、$\tilde{\Gamma}_\lambda$ は (\ref{def:gamma}) で定義され、$\tilde{C}_{i, \lambda}$ は (\ref{def:C}) で定義されます。
\end{thm}

\begin{table}[h]
    \centering
    \caption{}
    \label{table:theta-m_2}
    \renewcommand{\arraystretch}{1.5}
    \begin{tabular}{|c|c|c|}
    \hline
    $m$ & $\Theta_1$ & $\Theta_2$ \\ 
    \hline \hline
    $m = 1$ & $\frac{\Lambda^d \rho_{max}}{\gamma}$ & $\tau \Lambda^{d - 1}\rho_{max}$ \\ \hline
    $1 < m < 2$ & $\frac{{\Lambda^d(\rho_{max})}^{2 - m}}{\gamma m}$ & $\tau \Lambda^{d - 1}\rho_{max}$ \\ \hline
    $m = 2$ & $\frac{\Lambda^d}{2 \tau}$ & $\tau \Lambda^{d - 1}\rho_{max}$ \\ \hline
    $m > 2$ & $\Lambda^d {(\gamma m^\prime)}^{1 - m^\prime} \left( \tilde{C}_{1, \lambda} \tilde{\Gamma}_\lambda \lambda^{m^\prime - 1}  + \frac{m^\prime - 1}{\lambda^{2 - m^\prime}}\right)$ & $\Lambda^d {(\gamma m^\prime)}^{1 - m^\prime} \tilde{C}_{2, \lambda} \tilde{\Gamma}_\lambda + \tau \Lambda^{d - 1}\rho_{max}$ \\ \hline
    $m = \infty$ & $\Lambda^d \tilde{C}_{1, 0} \tilde{\Gamma}_0$ & $\Lambda^d \tilde{C}_{2, 0} \tilde{\Gamma}_0 +  \tau \Lambda^{d - 1}\rho_{max}$ \\ \hline
    \end{tabular}
\end{table}

\subsection{Back-and-forth for non-convex $U$}

\section{NUMERICAL IMPREMENTATION AND EXPERIMENTS}

\subsection{Implementation details}
\label{sect:Implementation details}

このセクションでは、内部エネルギーUに対する方程式(\ref{eq:Darcy's})をさまざまな場合に数値シミュレーションするために、back-and-forth法を使用します。
このセクション全体で、領域 $\Omega = [- 1 / 2, 1 / 2]^2$が$\mathbb{R}^2$の単位正方形であると仮定し、通常の長方形グリッドを使用して離散化します。

n個のポイントを持つ通常の長方形グリッド上で、高速Legendre変換(FLT)アルゴリズムを使用して前向きまたは逆向きの$c$-変換を$O(n)$の操作で計算できます。
$c$-変換とLegendre変換の等価性についての詳細については、[21]を参照してください。
重みづけられたノルム（\ref{eq:norm}）に関する勾配を計算する際、zero Neumann境界条件のポアソン方程式を解決する必要があります。
この方程式を高速フーリエ変換（FFT）を使用して数値的に解きます。

$I$および$J$の勾配を計算するには、pushforwardも計算する必要があります。
密度$\mu$および可逆な写像$T: \Omega \to \Omega$が与えられた場合、ヤコビアンの公式を使用してpushforward $T_\# \mu$を計算できます。

我々の場合、我々は前進と後退の$c$-変換によって誘導されるマップ$T_\varphi$および$T_\psi$に関連してプッシュフォワードを計算する必要があります。
BFMの構造のおかげで、$\varphi, \psi$がそれぞれ$c$-凸および$c$-凹の場合にのみ、$T_{\varphi \#} \mu$および$T_{\psi \#} \delta U^*(- \psi^c)$を計算する必要があります。
その結果、$T_\varphi ^{-1}(y) = y - \tau \nabla \varphi(y)$および$T_\psi^{-1}(x) = x - \tau \nabla \psi(x)$という簡単な式が得られます。

\[
    y = T_\phi(x), \quad x = T^{-1}_\phi (y), \quad dx = |\det \nabla T^{-1}_\phi (y)| dy 
\]

(\ref{eq:delta J}), (\ref{eq:delta I})から、
\begin{align*}
    T_{\phi \#} \mu (A) &= \int_A T_{\phi \#} \mu (x)\, dx = \mu(T^{-1}_\phi (A))\\
                        &= \int_{T^{-1}_\phi (A)} \mu(x) \, dx\\
                        &= \int_A \mu \left( T^{-1}_\phi(y) \right) |\det \nabla T^{-1}_\phi (y)|\, dy = \int_A \frac{\mu \left( T^{-1}_\phi(y) \right)}{|\det \nabla T\left(T^{-1}_\phi (y)\right)|}\, dy\\
                        &= \int_A \mu(y - \tau \nabla \phi(y))|\det (I - \tau D^2 \phi(y))|\, dy = \mu(y - \tau \nabla \phi(y))|\det (I - \tau D^2 \phi(y))|
\end{align*}
\begin{align*}
    T_{\psi \#} \delta U^* (- \psi^c) (A)   &= \int_A T_{\psi \#} \delta U^* (- \psi^c) (y)\, dy =  \delta U^* (- \psi^c)(T^{-1}_\psi (A))\\
                                            &= \int_{T^{-1}_\psi (A)} \delta U^* (- \psi^c) (y) \, dx\\
                                            &= \int_A  \delta U^* (- \psi^c)  \left(T^{-1}_\psi (x) \right) |\det \nabla T^{-1}_\psi (x)|\, dy = \int_A \frac{\ \delta U^* (- \psi^c)  \left( T^{-1}_\psi(x) \right)}{|\det \nabla T\left(T^{-1}_\psi (x)\right)|}\, dy\\
                                            &= \int_A \delta U^* (- \psi^c)(x - \tau \nabla \psi(x))|\det (I - \tau D^2 \psi(x))|\, dx = \delta U^* (- \psi^c)(x - \tau \nabla \psi(x))|\det (I - \tau D^2 \psi(x))|
\end{align*}

\begin{equation}
    \label{eq:pushforward Tphi}
    T_{\phi \#} \mu (y) =\mu(y - \tau \nabla \phi(y))|\det (I - \tau D^2 \phi(y))|
\end{equation}
\begin{equation}
    \label{eq:pushforward Tpsi}
    T_{\psi \#} \delta U^* (- \psi^c)(x) =\delta U^* (- \psi^c)(x - \tau \nabla \psi(x))|\det (I - \tau D^2 \psi(x))|
\end{equation}
実装する際、私たちのアルゴリズムではこれらの量をシンプルな中心差分スキームを使用して計算します。

\subsection{Experiments}
以下に、4つの数値実験のセットを紹介します。
最初の実験セットでは、私たちの方法の速度と精度を、Barrenblatソリューションと呼ばれる、方程式(\ref{eq:Darcy's})の特殊な場合で閉じた形のソリューションが利用可能な場合と比較することによって示します。
次の実験セットでは、興味深い関数$V: \Omega \to \mathbb{R} \cup {+ \infty}$および$m$の異なる値に対して、多孔質媒体方程式(PME)$\partial_t \rho = \Delta (\rho^m) + \nabla \cdot (\rho \nabla V)$をシミュレートします。
$V$が$\Omega$の閉じた集合$E \in \Omega$で$+ \infty$の値を取る場合、$\rho$は決して$E$に入ることはありません。
したがって、これは(\ref{eq:Darcy's})をより複雑な領域$\Omega \setminus  E$で解くことと同等です。
3番目の実験セットでは、セクション3.3からの分割スキームを使用して、$U$が凸でない場合に(\ref{eq:Darcy's})をシミュレートします。
この場合、非凸性は、$W(\rho) = \int_\Omega \int_\omega W(x - y) \rho(x)\rho(y) \,dx dy$の形式の相互作用エネルギーから発生します。
最後の実験セットでは、$U$がどこでも$\rho \le 1$の厳格な制約をエンコードする非圧縮流を研究します。
この場合、双対エネルギー$U^*$は$\rho$のサポートの境界で非常に特異なヘッシアンを持つでしょう。
それにもかかわらず、非常に細かいグリッド上で進化をシミュレートできます。





\subsubsection{Accuracy: Barenblatt solutions}


この実験では、バック・アンド・フォースアルゴリズムを使用して、PME（拡散方程式）
\begin{equation}
    \label{eq:PME}
    \partial_t\rho = \gamma\Delta(\rho^m)
\end{equation}
を解きます。初期データは
\[
    \rho(0,x) = M\delta_0(x)
\]
で与えられます。
ここで、\(\gamma > 0\)は拡散の速度を制御する定数であり、\(M > 0\)は初期総質量を表し、\(\delta_0\)は原点を中心とする標準的なディラックのデルタ分布です。
\(m > 1\)の場合、この方程式はエネルギー
\[
    U(\rho) = \int_\Omega \frac{\gamma}{m - 1}\rho(x)^m dx
\]
のWasserstein勾配流となります。
初期データの単純さにより、領域\(R\)上で方程式には閉じた形の解が存在し、これはBarenblatt solutionとして知られています。
Barenblatt solutionは以下のように与えられます(ただし、$(\cdot)_+ = max(\cdot, 0), \alpha = \frac{1}{m + 1}, \beta = \frac{1}{m + 1}$):
\[
    \rho(t,x)= \frac{1}{t^\alpha}\left(b - \frac{m - 1}{2m}\frac{\beta |x|^2}{t^{2\beta}} \right)_+^{\frac{1}{m - 1}}
\]

\begin{equation}
    \label{eq:barenblatt}
    \rho(t,x)= \frac{1}{t^{\frac{1}{m + 1}}}\left(b - \frac{m - 1}{2m}\frac{1}{m + 1} \frac{ |x|^2}{t^{\frac{2}{m + 1}}} \right)_+^{\frac{1}{m - 1}}
\end{equation}

$m = 2$のとき、
\begin{equation}
    \label{eq:barenblatt:m=2}
    \rho(t,x)= \frac{1}{t^{\frac{1}{3}}}\left(b - \frac{1}{12} \frac{ |x|^2}{t^{\frac{2}{3}}} \right)_+
\end{equation}

\begin{align*}
    \rho(t, x) = 0 &\iff \frac{1}{t^{\frac{1}{3}}}\left(b - \frac{1}{12} \frac{ |x|^2}{t^{\frac{2}{3}}} \right) = 0\\
                    &\iff b = \frac{1}{12}\frac{|x|^2}{t^{\frac{2}{3}}} \\
                    &\iff |x|^2 = 12t^{\frac{2}{3}}b \iff x = \pm \sqrt{12t^{\frac{2}{3}}b}
\end{align*}


% \begin{figure}
%     \centering
%     \begin{tikzpicture}
%         \begin{axis}[
%             width=0.8\textwidth,
%             height=6cm,
%             xlabel=$x$,
%             ylabel=$\rho(t, x)$,
%             legend style={at={(0.5,1.05)}, anchor=south},
%             legend columns=4,
%             grid=both,
%             grid style={dotted},
%             xmin=-0.5,
%             xmax=0.5,
%             ymin=0,
%             ymax=16,
%         ]
%         \addplot[color=red, domain=-0.5:0.5, samples=200, name path=graph1] {1 / (x^2 + 0.4) * (1 - (1/12) * (x^2 / 0.4))^(3/2)};
%         \addlegendentry{$t=0$};
        
%         \addplot[color=blue, domain=-0.5:0.5, samples=200, name path=graph2] {1 / (x^2 + 0.8) * (1 - (1/12) * (x^2 / 0.8))^(3/2)};
%         \addlegendentry{$t=0.4$};
        
%         \addplot[color=green, domain=-0.5:0.5, samples=200, name path=graph3] {1 / (x^2 + 2) * (1 - (1/12) * (x^2 / 2))^(3/2)};
%         \addlegendentry{$t=0.8$};
        
%         \addplot[color=orange, domain=-0.5:0.5, samples=200, name path=graph4] {1 / (x^2 + 2) * (1 - (1/12) * (x^2 / 2))^(3/2)};
%         \addlegendentry{$t=2$};
%         \end{axis} 
%     \end{tikzpicture}
% \end{figure} 


\begin{align*}
    \int^{+\infty}_{-\infty} \rho(t, x)dx &= 2 \int^{\sqrt{12t^{\frac{2}{3}}b}}_0 \frac{1}{t^{\frac{1}{3}}}\left(b - \frac{1}{12} \frac{|x|^2}{t^{\frac{2}{3}}}\right)dx\\
                                            &= \frac{2}{t^{\frac{1}{3}}}\left(b r - \frac{r^3}{3 \cdot 12 t^{\frac{2}{3}}}\right) & r = \sqrt{12t^{\frac{2}{3}}b}\\
                                            &= \frac{2}{t^{\frac{1}{3}}}\left(b r - \frac{12t^{\frac{2}{3}}b r}{3 \cdot 12 t^{\frac{2}{3}}}\right) = \frac{2}{t^{\frac{1}{3}}}\frac{2}{3}br\\
                                            &= \frac{2}{t^{\frac{1}{3}}}\frac{2}{3}b \cdot 2\cdot \sqrt{3} t^{\frac{1}{3}}\\
                                            &= \frac{8}{\sqrt{3}}b^{\frac{3}{2}} =: M  \qquad \Longrightarrow b = \left(\frac{\sqrt{3}}{8} M \right)^{\frac{2}{3}} \quad(M \text{ is total initial mass})
\end{align*}



そのため、質量が正方形の境界に達するまでの時間$t_c = \frac{m - 1}{16 m^2 \gamma}(\frac{\pi(m - 1)}{4mM})^{m - 1}$まで、$[- \frac{1}{2}, \frac{1}{2}]$の上の解と一致します。
Barenblatt solutionをベンチマーク（基準）として使用して、私たちの方法の精度と効率をテストできます。
指数$m = 2, 4, 6$の方程式をシミュレートします。
数値的にはディラックのデルタ関数は扱いにくいため、高さ$h_0 > 0$を固定し、時間$t_0 > 0$からフローを開始します。
{\color{red}
    ここで$t_0$は、$\|\rho(t_0, \cdot)\|_{L^\infty} = h_0$となるように選ぶ。
}
ただし、$t_0$の値は指数$m$に依存し、式（\ref{eq:barenblatt}）から明示的に求めることができることに注意する。
さらに、Barenblatt solutionは時間$t_c$までの間にのみ有効であるため、時間間隔$[t_0、t_c]$内でのフローのみを考慮します。

\begin{align*}
    \|\rho(t_0, \cdot)\|_{L^\infty} = h_0 \,
    \Longrightarrow \,\|\rho(t_0, \cdot)\|_{L^\infty} &= \sup_x{\|(t_0, x)\|} = \rho(t_0, 0) = \frac{1}{t^{\frac{1}{3}}} b\\
    \Longrightarrow \, t_0 = \left(\frac{b}{h_0}\right)
\end{align*}


{\color{red}
すべてのベンチマーク実験では、$M = 0.5, h_0 = 15, \gamma = 10^{-3}$を設定します。
}
小さな$\gamma$の値は、フローが巨視的な時間間隔で発生するようにするための時間の再スケーリングです。
さまざまなタイムステップサイズ$\tau = 0.4, 0.2, 0.1, 0.05, 0.025$で$t_0 \le t \le 2 + t_0$の時間進化を計算します（パラメータの選択により、$m = 2, 4, 6$の場合でも$t_0 + 2 < t_c$であることが確認できます）。
さまざまなタイムステップサイズで実験を実行することにより、スキームがタイムステップを減少させるほど正確になることを確認できます。
私たちは解の精度を$L^1$ノルムを使用して測定します。
これは、Wasserstein勾配フローの文脈では非常に自然な指標です（例:[20]を参照）。
私たちの誤差評価のための正確な式は次の通りです。
\begin{equation}
    \label{eq:error}
    error = \frac{1}{N_\tau} \sum_{n = 0}^{N_\tau} \int_\Omega |\rho(n \tau + t_0, x) - \rho^{(n)}(x)|\, dx
\end{equation}
ここでnは離散的な時間ステップを示します。
ただし、$N_\tau = \lfloor \tau^2 \rfloor$であり、$\rho(n\tau + t_0, x)$はBarenblatt解であり、
$\rho^{(n)}$は初期データ$\rho^{(0)}(x) = \rho(t_0, x)$から始まる$n$回目JKO反復です。
$\varphi^{(n+1)}$を求める際、アルゴリズム \ref{algo:baf scheme}を実行し、
残差$\|\delta U^*(- \varphi) - T_{\varphi \#} \mu \|_{L^1(\Omega)}$が$\varepsilon = 10^{-3}$未満になるまで続けます。

これらの実験の結果は、表1と図1に表示されています。
表1には誤差(\ref{eq:error})と上記の実験すべての合計計算時間が表示されています。
図1では、解の断面図とさまざまな時間スナップショットでの正確な解がプロットされています。
断面図は、水平線$\{(x_1, 0) : x_1 \in [-1/2, 1/2]\}$に沿って取られます。
時間ステップを小さくすると、数値解が指数$m = 2, 4, 6$のすべての場合に正確な解と非常に一致することがわかります。
図1はまた、手法が$\rho$の台$(Supp \rho = \{ x | \rho(x) \neq 0\})$の境界で$\nabla\rho$の不連続性を正しく捉えていることを示しています。
これは他の多くの数値方法が不連続性を滑らかにするのに対して、提案手法が正しく捉える理由です。

我々が不連続性を正しく捉えることができる理由は、
\[
    \rho^{(n+1)} = \delta U^*(- \varphi^{(n+1)}) = \left( \frac{m - 1}{m \gamma} \max(C - \varphi, 0)\right)^{\frac{1}{m-1}}
\]
という双対関係を通じて密度を回復するためです。
関数$s(x) = \max(x, 0)^{\frac{1}{m-1}}$はゼロで不連続な導関数を持っているため、
$\varphi^{(n+1)}$が滑らかであっても、$\nabla\rho$はその台の境界で不連続性を持つでしょう。



\begin{table}[hbtp]
    \centering
    \begin{subtable}{.5\textwidth}
        \centering
        \caption{Solving Laplace eq by FFT.}
        \label{table:baf_fft_test}
        \input{../../Codes/result/result_baf_fft512.tex}
    \end{subtable}%
    \begin{subtable}{.5\textwidth}
        \centering
        \caption{Solving Laplace eq by Gaussian elimination.}
        \label{table:baf_gauss_test}
        \input{../../Codes/result/result_baf_gauss512_eps=1e-3.tex}
    \end{subtable}
    \caption{Back and forth method (grid size $512$)}
\end{table}

% \begin{table}[hbtp]
%     \caption{Back and forth method baf (grid size $512$)}
%     \label{table:baf_fft_test}
%     \centering
%     \input{../../Codes/result_baf_fft.tex}
% \end{table}

% \begin{table}[hbtp]
%     \caption{Back and forth method gauss (grid size $512$)}
%     \label{table:baf_gauss_test}
%     \centering
%     \input{../../Codes/result_baf_gauss.tex}
% \end{table}

\begin{table}[hbtp]
    \centering
    \begin{subtable}{.5\textwidth}
        \centering
        \caption{Solving Laplace eq by FFT.}
        \label{table:baf_fft_test}
        \input{../../Codes/result/result_baf_fft1000.tex}
    \end{subtable}%
    \begin{subtable}{.5\textwidth}
        \centering
        \caption{Solving Laplace eq by Gaussian elimination.}
        \label{table:baf_gauss_test}
        \input{../../Codes/result/result_baf_gauss1000.tex}
    \end{subtable}
    \caption{Back and forth method (grid size $1000$, $\epsilon=\num{1e-3}$)}
\end{table}

\begin{table}[hbtp]
    \centering
    \begin{subtable}{.5\textwidth}
        \centering
        \caption{Solving Laplace eq by FFT.}
        \label{table:baf_fft_test}
        \input{../../Codes/result/result_baf_fft2000.tex}
    \end{subtable}%
    \begin{subtable}{.5\textwidth}
        \centering
        \caption{Solving Laplace eq by Gaussian elimination.}
        \label{table:baf_gauss_test}
        \input{../../Codes/result/result_baf_gauss2000.tex}
    \end{subtable}
    \caption{Back and forth method (grid size $2000$, $\epsilon=\num{1e-3}$)}
\end{table}

\begin{table}[hbtp]
    \centering
    \begin{subtable}{.5\textwidth}
        \centering
        \caption{Solving Laplace eq by FFT.}
        \label{table:baf_fft_test}
        \input{../../Codes/result/result_baf_fft4000.tex}
    \end{subtable}%
    \begin{subtable}{.5\textwidth}
        \centering
        \caption{Solving Laplace eq by Gaussian elimination.}
        \label{table:baf_gauss_test}
        \input{../../Codes/result/result_baf_gauss4000_eps=1e-3.tex}
    \end{subtable}
    \caption{Back and forth method (grid size $4000$, $\epsilon=\num{1e-3}$)}
\end{table}

\begin{table}[hbtp]
    \centering
    \begin{subtable}{.5\textwidth}
        \centering
        \caption{grid size $4000$, $\epsilon=\num{1e-5}$}
        \label{table:baf_fft_test}
        \input{../../Codes/result/result_baf_gauss4000_eps=1e-5.tex}
    \end{subtable}%
    \begin{subtable}{.5\textwidth}
        \centering
        \caption{grid size $4000$, $\epsilon=\num{1e-6}$}
        \label{table:baf_gauss_test}
        \input{../../Codes/result/result_baf_gauss4000_eps=1e-6.tex}
    \end{subtable}
    \caption{Back and forth method, solving Laplace eq by Gaussian elimination.(grid size $4000$)}
\end{table}


\begin{table}[hbtp]
    \centering
    \begin{subtable}{.5\textwidth}
        \centering
        \caption{grid size $512$}
        \label{table:baf_fft_test}
        \input{../../Codes/result/result_bbr512.tex}
    \end{subtable}%
    \begin{subtable}{.5\textwidth}
        \centering
        \caption{grid size $1000$}
        \label{table:baf_gauss_test}
        \input{../../Codes/result/result_bbr1000.tex}
    \end{subtable}
    \caption{Berger Brezis Rogers scheme }
\end{table}

\begin{table}[hbtp]
    \centering
    \begin{subtable}{.5\textwidth}
        \centering
        \caption{grid size $2000$}
        \label{table:baf_fft_test}
        \input{../../Codes/result/result_bbr2000.tex}
    \end{subtable}%
    \begin{subtable}{.5\textwidth}
        \centering
        \caption{grid size $4000$}
        \label{table:baf_gauss_test}
        \input{../../Codes/result/result_bbr4000.tex}
    \end{subtable}
    \caption{Berger Brezis Rogers scheme }
\end{table}

\begin{table}[hbtp]
    \caption{Explicit Euler method (grid seize $512$)}
    \label{table:baf_test}
    \centering
    \input{../../Codes/result/result_euler512.tex}
\end{table}

  \begin{figure}
    \centering
    \begin{minipage}{0.4\hsize}
        \includegraphics[width=\linewidth]{../../images/baf_tau/t=0.png}
        \caption{$t = 0$}
    \end{minipage}
    \begin{minipage}{0.4\hsize}
        \includegraphics[width=\linewidth]{../../images/baf_tau/t=0.4.png}
        \caption{$t = 0.4$}
    \end{minipage}
    \begin{minipage}{0.4\hsize}
        \includegraphics[width=\linewidth]{../../images/baf_tau/t=0.8.png}
        \caption{$t = 0.8$}
    \end{minipage}
    \begin{minipage}{0.4\hsize}
        \includegraphics[width=\linewidth]{../../images/baf_tau/t=2.png}
        \caption{$t = 2$}
    \end{minipage}
    \caption{1d computed solutions using baf method and the exact Barenblatt solution at times $t  = 0, t_0 + 0.4, t_0 + 0.8, t_0 + 2$}
\end{figure}

\begin{figure}
    \centering
    \begin{minipage}{0.4\hsize}
        \includegraphics[width=\linewidth]{../../images/bbr_tau/t=0.png}
        \caption{$t = 0$}
    \end{minipage}
    \begin{minipage}{0.4\hsize}
        \includegraphics[width=\linewidth]{../../images/bbr_tau/t=0.4.png}
        \caption{$t = 0.4$}
    \end{minipage}
    \begin{minipage}{0.4\hsize}
        \includegraphics[width=\linewidth]{../../images/bbr_tau/t=0.8.png}
        \caption{$t = 0.8$}
    \end{minipage}
    \begin{minipage}{0.4\hsize}
        \includegraphics[width=\linewidth]{../../images/bbr_tau/t=2.png}
        \caption{$t = 2$}
    \end{minipage}
    \caption{1d computed solutions using bbr method and the exact Barenblatt solution at times $t  = 0, t_0 + 0.4, t_0 + 0.8, t_0 + 2$}
\end{figure}

\begin{figure}
    \centering
    \begin{minipage}{0.4\hsize}
        \includegraphics[width=\linewidth]{../../images/euler_tau/t=0.png}
        \caption{$t = 0$}
    \end{minipage}
    \begin{minipage}{0.4\hsize}
        \includegraphics[width=\linewidth]{../../images/euler_tau/t=0.4.png}
        \caption{$t = 0.4$}
    \end{minipage}
    \begin{minipage}{0.4\hsize}
        \includegraphics[width=\linewidth]{../../images/euler_tau/t=0.8.png}
        \caption{$t = 0.8$}
    \end{minipage}
    \begin{minipage}{0.4\hsize}
        \includegraphics[width=\linewidth]{../../images/euler_tau/t=2.png}
        \caption{$t = 2$}
    \end{minipage}
    \caption{1d computed solutions using Explicit Euler method and the exact Barenblatt solution at times $t  = 0, t_0 + 0.4, t_0 + 0.8, t_0 + 2$}
\end{figure}

\subsubsection{Slow diffusion with drifts and obstacles}
\subsubsection{Non-convex U (aggregation-diffusion)}
\subsubsection{Incompressible projections and flows}

\section{Appendix}
\subsection*{自乗可積分}
\hypertarget{自乗可積分}
自乗可積分関数(square-integrable function)とは、実数値または複素数値可測函数で絶対値の自乗の積分が有限であるものである。すなわち
$$
    \int_{- \infty}^{\infty} |f(x)|^2 dx < + \infty
$$
ならば、$f$は実数直線 $(- \infty, + \infty)$ 上で自乗可積分である。場合によっては積分区間が $[0, 1]$ のように有界区間のこともある。


\subsection*{Legendre変換 (凸共役)}
\hypertarget{凸共役}
関数$\xi$を$\omega$上で定義された凸で微分可能な関数としたとき、そのLegendre変換(凸共役)\,$\xi^*$は以下のように定義できる.
$$
    \xi^*(p) := \sup_x p \cdot x - \xi(x) 
$$

ここで、双対汎関数$J$は$J(\varphi) =  \int \phi\, \nu  + \int \phi^c \, \mu$で定義していたことを思い出す。
{\color{teal}
これは凹な汎関数であり、第一項 $\int \phi\, \nu$ は$\phi$に対して線形であるため、$J$の凸性には影響しません。
}
そのため、$F$を次のように定義します。
\begin{equation}
    F(\phi) = - \int \phi^c \, \mu,
\end{equation}
これは、本質的には線形項のみが異なるため、$J$と同じ凸性を持つ凸関数です.
例えば、任意のポテンシャル $\phi_1$ と $\phi_2$ に対して、次の式が成立することを直接確認できます。
{\color{teal}
\begin{equation}
    J(\phi_2|\phi_1) = -F(\phi_2|\phi_1).
\end{equation}
}
最後に、$F$の凸共役は次のように定義されます。
\begin{equation}
    F^*(\rho) := \int_\omega \phi \, \rho - F(\phi)
\end{equation}


\subsection*{Proof}

\begin{proof}[Proof of Lemma \ref{lem:c-transform}]
    \hypertarget{proof:lem:c-transform}{}
    \begin{align*}
        \phi^c(x)    &= \inf_{y\in\Omega} \left(\frac{1}{2 \tau}|x - y|^2 - \phi(y)\right)\\
        \phi^{cc}(y) &= \inf_{x\in\Omega} \left(\frac{1}{2 \tau}|x - y|^2 - \phi^c(x)\right)\\
                  &= \inf_{x\in\Omega} \left(\frac{1}{2 \tau}|x - y|^2 - \inf_{z\in\Omega} \left(\frac{1}{2 \tau}|x - z|^2 - \phi(z)\right)\right)\\
                  &\ge  \inf_{x\in\Omega} \left(\frac{1}{2 \tau}|x - y|^2 - \left(\frac{1}{2 \tau}|x - y|^2 - \phi(y)\right)\right)\\
                  &= \phi(y).
    \end{align*}

    次に$\phi^{cc} = \phi$の必要十分条件は$\phi$が$c$-concaveであることを示す。

    $(\Leftarrow)$

    $\phi: c$-concaveすなわち、$\exists \psi \, s.t. \, \phi = \psi^c$のとき、$\phi^{cc} = \phi$を示す。

    $\exists \psi \, s.t. \, \phi = \psi^c$と仮定する。
    $\psi := \phi^c$とおくと、
    $$
    \phi = \psi^c = (\phi^c)^c= \phi^{cc}
    $$

    $(\Rightarrow)$

    $\phi^{cc} = \phi$のとき、$\phi: c$-concaveすなわち、$\exists \psi \, s.t. \, \phi = \psi^c$を示す。

    $\phi^{cc} = \phi$と仮定すると、
    $$
    \phi = \phi^{cc} = (\phi^c)^c
    $$
    よって、$\phi = (\phi^c)^c$となる$\phi^c$が存在する。したがって、$\phi$は$c$-concaveである。


    最後に、$\phi^{ccc} = \phi$を示す。
    まず、$\phi^{ccc} \geq \phi^c$を示す。
    \begin{align*}
    \phi^{ccc}(x)   &= \inf_{w \in \Omega} \left( \frac{1}{2 \tau} |x - w|^2 - \phi^{cc}(w) \right)\\
                    &= \inf_{w \in \Omega} \left( \frac{1}{2 \tau} |x - w|^2 - \inf_{z \in \Omega}\left( \frac{1}{2 \tau} |w - z|^2 - \phi^c(z)\right)\right)\\
                    &= \inf_{w \in \Omega} \left( \frac{1}{2 \tau} |x - w|^2 + \sup_{z \in \Omega}\left( - \frac{1}{2 \tau} |w - z|^2 + \phi^c(z)\right)\right)\\
                    &\geq \inf_{w \in \Omega} \left( \frac{1}{2 \tau} |x - w|^2 + \left( - \frac{1}{2 \tau} |w - x|^2 + \phi^c(x)\right)\right)\\
                    &= \phi^c(x)\\
    \end{align*}
    次に、$\phi^{ccc} \leq \phi^c$を示す。
    \begin{align*}
    \phi^{ccc}(x)   &= \inf_{w \in \Omega} \left( \frac{1}{2 \tau} |x - w|^2 - \phi^{cc}(w) \right)\\
                    &\leq \inf_{w \in \Omega} \left( \frac{1}{2 \tau} |x - w|^2 - \phi(w) \right)\\
                    &= \phi^c(x)\\
    \end{align*}
    よって、$\phi^{ccc} = \phi^c$が示された。

    {\color{gray}
    $\phi^{cc} = \phi$の必要十分条件は$\phi$が$c$-concaveであることを示す。(別解)

    $(\Leftarrow)$

    $\phi: c$-concaveすなわち、$\exists \psi \, s.t. \, \phi = \psi^c$のとき、$\phi^{cc} = \phi$を示す。

    $\phi = \psi^c$と仮定すると、
    $$
    \phi^{cc} =（\psi^{cc})^c = \psi^{ccc} = \psi^c = \phi
    $$

    $(\Rightarrow)$
    $\phi^{cc} = \phi$のとき、$\phi: c$-concaveすなわち、$\exists \psi \, s.t. \, \phi = \psi^c$を示す。

    $\phi^{cc} = \phi$と仮定すると、
    $$
    \phi = \phi^{cc} = (\phi^c)^c
    $$
    よって、$\phi = (\phi^c)^c$となる$\phi^c$が存在する。したがって、$\phi$は$c$-concaveである。
    }
\end{proof}

\begin{proof}[Proof of Proposition \ref{lem:c-transform}]
    \hypertarget{proof:prop:transport map}{}
    \quad\par
    まず、写像$T_\phi(x)$がwell-definedであることを示します。
    つまり、任意の$x \in \Omega$に対して$\underset{y \in \Omega} {\operatorname{argmin}}\left( \frac{1}{2 \tau} |x - y|^2 - \phi(y) \right)$が存在することを示す。
    関数$\frac{1}{2 \tau} |x - y|^2 - \phi(y)$は$\Omega$上の連続関数であり、$\Omega$がコンパクト(閉集合$\to$コンパクト)であることから、この関数は最小値を持つことが保証される。(コンパクト空間の連続関数はmaxとminを持つ。)
    したがって、$\underset{y \in \Omega} {\operatorname{argmin}}\left( \frac{1}{2 \tau} |x - y|^2 - \phi(y) \right)$は存在する。
    
    次に、$T_\phi(x)$がalmost everywhereで一意であることを示しす。
    つまり、ほとんど全ての$x \in \Omega$に対して、$\underset{y \in \Omega} {\operatorname{argmin}}\left( \frac{1}{2 \tau} |x - y|^2 - \phi(y) \right)$がただ一つの要素を持つことを示す。
    $\phi$が$c$-concaveであることから、\hypertarget{convex set of T}{$T_\phi(x) = \underset{y \in \Omega} {\operatorname{argmin}}\left( \frac{1}{2 \tau} |x - y|^2 - \phi(y) \right)$は凸集合}となります。(\hyperlink{convex set}{Proof}) 
    また、凸集合上の任意の点は最小値を持つ点として一意に定まります。
    したがって、ほとんど全ての$x \in \Omega$に対して$\underset{y \in \Omega} {\operatorname{argmin}}\left( \frac{1}{2 \tau} |x - y|^2 - \phi(y) \right)$がただ一つの要素を持つことが示されます。
    
    {\color{teal}
    さらに、$u \in C(\Omega)$の場合、ほとんど全ての$x, y \in \Omega$に対して以下の摂動公式が成り立つことを示します。
    }
    $$
    \lim_{\varepsilon \to 0} \frac{(\phi + \varepsilon u)^c(x) - \phi^c(x)}{\varepsilon} = - u(T_\phi(x))
    $$


    まず、
    \begin{align*}
        \phi^c(x) &:= \inf_{y\in\Omega} \left(\frac{1}{2 \tau}|x - y|^2 - \phi(y)\right).\\
        (\phi + \epsilon u)^c(x) &= \inf_{y\in\Omega} \left(\frac{1}{2 \tau}|x - y|^2 - (\phi(y) + \epsilon u(y))\right).
        \end{align*}
    この時、
    \begin{align*}
    (\phi + \epsilon u)^c(x) - \phi^c(x) &= \inf_{y\in\Omega} \left(\frac{1}{2 \tau}|x - y|^2 - (\phi(y) + \epsilon u(y))\right) - \inf_{y\in\Omega} \left(\frac{1}{2 \tau}|x - y|^2 - \phi(y)\right) \\
    &= \inf_{y\in\Omega} \left(\frac{1}{2 \tau}|x - y|^2 - (\phi(y) + \epsilon u(y)) - \left(\frac{1}{2 \tau}|x - y|^2 - \phi(y)\right)\right) \\
    &= \inf_{y\in\Omega} \left(-\epsilon u(y)\right) \\
    &= -\epsilon \inf_{y\in\Omega} u(y) \\
    &= -\epsilon u \left(T_\phi(x)\right).  \qquad (\because \text{def of}\,  T_\phi (\text{$\phi^c$が最小値を取るとき、$y = T_\phi(x)$}))
    \end{align*}
    
    よって、
    
    \begin{align*}
       \lim_{\epsilon \to 0}\frac{(\phi + \epsilon u)^c(x) - \phi^c(x)}{\epsilon} &=  \lim_{\epsilon \to 0} \frac{-\epsilon u \left(T_\phi(x)\right)}{\epsilon} \\
    &= -u (T_\phi(x)).
    \end{align*}
    
    したがって、$\lim_{\epsilon \to 0} \frac{(\phi + \epsilon u)^c(x) - \phi^c(x)}{\epsilon} = -u(T_\phi(x))$ が証明されました。
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%    
    
    次に、$T_\phi(x) = x - \tau \nabla \phi(x)$が成り立つことを示します。
    
    $\phi^c(x) = \inf_{y\in\Omega} \left(\frac{1}{2 \tau}|x - y|^2 - \phi(y)\right)$より、$\phi^c$は$x$についての関数である。
    よって$\frac{1}{2 \tau}|x - y|^2- \phi(y)$最小値は$\frac{\partial }{\partial x} (\frac{1}{2 \tau}|x - y|^2- \phi(y)) = \nabla (\frac{1}{2 \tau}|x - y|^2- \phi(y)) = 0$となる点の値である。
    なぜなら、$\frac{1}{2 \tau}|x - y|^2- \phi(y)$は凸関数であるためである。($\phi$が凹関数より、$- \phi$は凸関数のため)
    よって、もちろん$\phi^c(x)$も凸関数。よって、
    
    $$
      \nabla (\frac{1}{2 \tau}|x - y|^2- \phi(y)) = \frac{1}{\tau}(x - y)
    $$
    $T_\phi$の定義から、$y = T_\phi$のとき、$\frac{1}{2 \tau}|x - y|^2- \phi(y)$が$\inf$をとる。
    すなわち、$y = T_\phi$のとき、$\frac{1}{2 \tau}|x - y|^2- \phi(y) = \phi^c(x)$となる。
    よって、上の式を書き換えると
    $$
        \nabla \phi^c(x) = \frac{1}{\tau}(x - T_\phi(x))
    $$
    よって、
    \begin{eqnarray*}
        &\nabla \phi^c(x) = \frac{1}{\tau}(x - T_\phi(x)) \\
        \iff& \tau \nabla \phi^c(x) = x - T_\phi(x)\\
        \iff& T_\phi(x) = x - \tau \nabla \phi^c(x)
    \end{eqnarray*}
    同様に、以下も成り立つ。
    $$
            T_\psi(y) = y - \tau \nabla \psi^c(y),
    $$
    \begin{align*}
        T_\psi(T_\phi(x))   &= T_\psi(x - \nabla \phi^c(x))\\
                            &= y - \tau \nabla \psi(y)
    \end{align*}
    
\end{proof}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
{\color{gray}

申し訳ありません、先ほどの回答に誤りがありました。正しい証明を以下に示します。

与えられた条件から、$T_\phi(x) = x - \tau \nabla \phi^c(x)$および$T_\psi(x) = x - \tau \nabla \psi(x)$とします。

$T_\phi(T_\psi(x))$を計算すると、
\begin{align*}
T_\phi(T_\psi(x)) &= T_\phi(x - \tau \nabla \psi(x)) \\
&= x - \tau \nabla \phi^c(x - \tau \nabla \psi(x)).
\end{align*}

ここで、$\phi^c = \inf_y \left(\frac{1}{2 \tau}|x - y|^2 - \phi(y)\right)$を考慮します。

$\nabla \phi^c(x - \tau \nabla \psi(x))$を計算すると、
\begin{align*}
\nabla \phi^c(x - \tau \nabla \psi(x)) &= \nabla \left(\frac{1}{2 \tau}|x - y|^2 - \phi(y)\right) \bigg|_{y = x - \tau \nabla \psi(x)} \\
&= \frac{1}{\tau}(x - (x - \tau \nabla \psi(x))) - \nabla \phi(x - \tau \nabla \psi(x)) \\
&= \nabla \psi(x) - \nabla \phi(x - \tau \nabla \psi(x)).
\end{align*}

したがって、$T_\phi(T_\psi(x))$は以下のようになります。
\begin{align*}
T_\phi(T_\psi(x)) &= x - \tau \nabla \phi^c(x - \tau \nabla \psi(x)) \\
&= x - \tau (\nabla \psi(x) - \nabla \phi(x - \tau \nabla \psi(x))) \\
&= x - \tau \nabla \psi(x) + \tau \nabla \phi(x - \tau \nabla \psi(x)).
\end{align*}

この式から分かるように、$T_\phi(T_\psi(x))$は$x$と一致します。

以上が、$T_\phi(T_\psi(x)) = x$の証明です。お間違えによる誤解を招いたことをお詫び申し上げます。
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{proof}[\hyperlink{convex set of T}{Proof of \hypertarget{convex set}{$T_\phi(x) = \underset{y \in \Omega} {\operatorname{argmin}}\left( \frac{1}{2 \tau} |x - y|^2 - \phi(y) \right)$は凸集合}}]
    \quad\par
    $\phi$が$c$-concaveであると仮定します。
    
    関数$f(y) = \frac{1}{2 \tau} |x - y|^2 - \phi(y)$を考えます。この関数は凸関数です。なぜなら、次のような理由からです：
    
    \begin{enumerate}
        \item 二次関数$\frac{1}{2 \tau} |x - y|^2$は凸関数です。二次関数はそのヘッセ行列が半正定値であるため、凸性を持ちます。
        \item $\phi$が$c$-凹関数より、$-\phi(y)$は下に凸です。$\phi$が$c$-concaveであるため、$\phi$の下に凸な接平面が存在し、その接平面よりも下に凸な部分を持ちます。
        \item 凸関数の足し算は凸関数。
    \end{enumerate}
    
    したがって、$f(y) = \frac{1}{2 \tau} |x - y|^2 - \phi(y)$は凸関数です。
    
    関数$f(y)$の最小値を実現する点の集合は凸集合です。なぜなら、凸関数の最小値を実現する点の集合は常に凸集合であり、$f(y)$は凸関数であるためです。
    
    したがって、$\underset{y \in \Omega} {\operatorname{argmin}}\left( \frac{1}{2 \tau} |x - y|^2 - \phi(y) \right)$は凸集合です。
\end{proof}
    

\begin{proof}[Proof of Proposition \ref{prop:wasserstein}]
    \hypertarget{proof:prop:wasserstein}{}
    \quad\par
    注意しておきますが、
    {\color{teal}
    与えられた \((\varphi, \psi) \in C\) に対して、{\color{red}\(\phi^c \geq \psi\) }が成り立ちます。
    }
    ただし、
    \[
    \phi^c(x) := \inf_y \left( \frac{1}{2\tau}|x-y|^2 - \phi(y)\right)
    \]
    は \(\phi\) の c-変換（c-transform）です。なぜなら、
    $
        \mathcal{C}  := \{(\phi, \psi) \in C(\Omega) \times C(\Omega) : \psi(x) + \phi(y) \leq \frac{1}{2 \tau} |x - y|^2 \}. 
    $
    であり,
    $
    \psi(x) \le \frac{1}{2\tau}|x-y|^2 - \phi(y)
    $
    したがって、以下のようになります。
    \begin{align*}
        \frac{1}{2 \tau}W_2^2(\mu, \nu) &= \sup_{(\psi(x), \phi(y)) \in C}  \left( \int \psi(x) d\mu(x) + \int \phi(y) d\nu(y) \right),\\
                                        &\leq \sup_{\phi \in C(\Omega)} \left( \int_{\Omega} \phi^c(x) \mu(x)dx + \int_{\Omega} \phi(y) \nu(y)dy \right) 
    \end{align*}

    また、$(\varphi, \psi) \in \mathcal{C} \implies (\psi^c, \psi) \in \mathcal{C}$
    であるので,
    \[
        \sup_{(\psi(x), \phi(y)) \in C}  \left( \int \psi(x) d\mu(x) + \int \phi(y) d\nu(y) \right) \geq \sup_{\phi \in C(\Omega)} \left( \int_{\Omega} \phi^c(x) \mu(x)dx + \int_{\Omega} \phi(y) \nu(y)dy \right) 
    \]
    が成立する。よって,
    \[
        \sup_{(\psi(x), \phi(y)) \in C}  \left( \int \psi(x) d\mu(x) + \int \phi(y) d\nu(y) \right) = \sup_{\phi \in C(\Omega)} \left( \int_{\Omega} \phi^c(x) \mu(x)dx + \int_{\Omega} \phi(y) \nu(y)dy \right) 
    \]
\end{proof}

\begin{proof}[Proof of Theorem \ref{thm:pushforward measure}]
    \hypertarget{proof:thm:pushforward measure}{}
    
\end{proof}

\begin{proof}[Proof of Lemma \ref{lem:monotone increasing}]
    \hypertarget{proof:lem:monotone increasing}{}
    \quad\par
    Assuption \ref{ass:rho>0} により、内部エネルギーは非負の密度に対してのみ有限です。
    したがって、
    $$
        U^*(\phi) = \sup_{\rho \geq 0} \left\{ \int_\Omega \phi(y) \rho(y) dy - U(\rho) \right\}.
    $$
    ある $\rho \in L^1(\Omega)$ を取る、ただし$\rho(y) \geq 0 \text{ a.e.}$ であるとします。
    すると、次の不等式が成り立ちます。
    $$
        \int \phi_0(y) \rho(y) dy - U(\rho) \leq \int \phi_1(y) \rho(y) dy - U(\rho).
    $$
    $\rho \geq 0$ に対して上記の不等式の上限を取ることで、証明が完了する。
    
\end{proof}

\begin{proof}[Proof of Proposition \ref{prop:functional}]
    \hypertarget{proof:prop:functional}{}
    \quad\par
    Lemma \ref{lem:monotone increasing}の証明の論理に従って、次のように表現することができます。
    $$
        U^*(\psi^c) = \sup_{\rho \geq 0} \left( \int_\Omega \psi^c(y) \rho(y) dy - U(\rho) \right).
    $$
    $$
        U^*(- \psi^c) = \sup_{\rho \geq 0} \left( \int_\Omega - \psi^c(y) \rho(y) dy - U(\rho) \right).
    $$

    次に、$\mathcal{M}(\Omega \times \Omega)$を$\Omega \times \Omega$上の非負測度の集合とし、与えられた密度$\rho \geq 0$に対して次のように定義します。

    \[
        \Pi(\rho) = \left\{ \pi \in \mathcal{M}(\Omega \times \Omega) : \iint_{\Omega \times \Omega} f(y) \, d\pi(x, y) = \int_\Omega f(y) \rho(y) \, dy,  \, \forall f \in C(\Omega) \right\}.
    \]

    c-変換の定義を用いると、式は次のように書けます。

    \begin{align*}
        \int_\Omega - \psi^c(y) \rho(y) \, dy   &= - \int_\Omega \inf_{x \in \Omega} \left( \frac{1}{2\tau}|x-y|^2 - \psi(x)\right) \rho(y) \, dy,\\
                                                &= \int_\Omega  \sup_{x \in \Omega} \left( \psi(x) - \frac{1}{2\tau}|x-y|^2 \right) \rho(y) \, dy,\\
                                                &= \sup_{\pi \in \Pi(\rho)} \iint_{\Omega \times \Omega}\left(\psi(x) - \frac{1}{2 \tau}|x-y|^2 \right)\, d\pi(x, y).
    \end{align*}

    したがって、以下のようになります。

    \begin{align*}
        - U^*(- \psi^c) &= - \sup_{\rho \geq 0} \left( \int_\Omega - \psi^c(y) \rho(y) dy - U(\rho) \right),\\
                        &= - \sup_{\rho \geq 0} \left( \sup_{\pi \in \Pi(\rho)} \left(\iint_{\Omega \times \Omega}  \left(\psi(x) - \frac{1}{2 \tau}|x-y|^2 \right) \, d\pi(x, y) \right)- U(\rho) \right),\\
                        &= \inf_{\rho \geq 0} \left( - \sup_{\pi \in \Pi(\rho)} \left(\iint_{\Omega \times \Omega} \left(\psi(x) - \frac{1}{2 \tau}|x-y|^2 \right) \, d\pi(x, y) \right) + U(\rho) \right),\\
                        &= \inf_{\rho \geq 0} \left( \inf_{\pi \in \Pi(\rho)} \left( - \iint_{\Omega \times \Omega}  \left(\psi(x) - \frac{1}{2 \tau}|x-y|^2 \right) \, d\pi(x, y) \right) + U(\rho) \right),\\
                        &= \inf_{\rho \geq 0} \inf_{\pi \in \Pi(\rho)} U(\rho) -  \iint_{\Omega \times \Omega} \left( \psi(x) - \frac{1}{2 \tau} |x - y|^2\right) \, d\pi(x, y)
    \end{align*}

    これにより、$I$は$\psi$に関する一連の線形汎関数の下限として表現できることが明らかになりました。
    {\color{teal}
    したがって、$I$はproperであり、凹であり、弱上半連続です。同様の議論が$J$にも適用されます。
    $U^*$が単調増加であることから($-U^*(- \cdot)$が単調増加であることから)、Lemma \ref{lem:monotone increasing}は任意の$\varphi$、$\psi \in C(\Omega)$に対して次の不等式が成り立つことを意味します。
    \[
        J(\varphi) \leq I(\varphi^c), \quad I(\psi) \leq J(\psi^c)
    \]
    したがって、次の関係が成り立ちます。
    \[
        \sup I(\psi) = \sup J(\varphi).
    \]
    }
    $\varphi$と$\psi$が$c$-凹性を持つ場合、一次変分の式はProposition \ref{prop:transport map}から直接導かれます。
    \begin{equation*}
        \delta J(\phi) = \delta U^*(- \phi) - T_{\phi \#} \mu,
    \end{equation*}
    \begin{equation*}
        \delta I(\psi) = \mu - T_{\psi \#} \delta U^* (- \psi^c).
    \end{equation*}

    \begin{align*}
        J(\phi) &= \int_{\Omega} \phi^c(x) \mu(x) \,dx - U^*(- \phi)\\
        J(\phi + \epsilon u) &= \int_{\Omega} (\phi + \epsilon u)^c(x)\mu(x) \,dx - U^*(- \phi - \epsilon u)
    \end{align*}
    より、
    \begin{align*}
        J(\phi + \epsilon u) - J(\phi)  &= \int_{\Omega} (\phi + \epsilon u)^c(x)\mu(x) \,dx - U^*(- \phi - \epsilon u) - \left( \int_{\Omega} \phi^c(x) \mu(x) \,dx - U^*(- \phi) \right)\\
                                        &= \int_\omega \left((\phi + \epsilon u)^c(x) - \phi^c(x) \right) \mu(x) \,dx - \left(U^*(- \phi - \epsilon u) - U^*(- \phi) \right)
    \end{align*}
    ここで、Proposition \ref{prop:transport map}を用いると、
    \begin{align*}
        \lim_{\epsilon \to 0} \frac{J(\phi + \epsilon u) - J(\phi)}{\epsilon} &= \lim_{\epsilon \to 0} \int_\omega \frac{(\phi + \epsilon u)^c(x) - \phi^c(x)}{\epsilon}\mu(x) \,dx - \frac{\left(U^*(- \phi - \epsilon u) - U^*(- \phi) \right)}{\epsilon}\\
                                                            \delta J(\phi)(u)  &= \int_\omega \lim_{\epsilon \to 0} \frac{(\phi + \epsilon u)^c(x) - \phi^c(x)}{\epsilon} \, d\mu(x) - \lim_{\epsilon \to 0}\frac{\left(U^*(- \phi - \epsilon u) - U^*(- \phi) \right)}{\epsilon}\\
                                                                              &= - \int_\omega u(T_\phi(x)) \, d\mu(x) + \delta U^*(- \phi)(u)\\
                                                                              &=  - \int_\omega u(x) \, d\, T_{\phi \#} \mu(x) + \delta U^*(- \phi)(u) & (\because (\ref{def:pushforward_int}))\\
                                                                              &=  - \int_\omega u(x) T_{\phi \#} \mu(x) \, dx + \delta U^*(- \phi)(u)\\
                                                                              &= - \int_\omega u(x) T_{\phi \#} \mu(x)\, dx + \delta U^*(- \phi)(u)\\
                                                                              &= \delta U^*(- \phi)(u) - \int_\omega u T_{\phi \#} \mu
    \end{align*}
    よって、
    \begin{equation*}
        \delta J(\phi) = \delta U^*(- \phi) - T_{\phi \#} \mu
    \end{equation*}
    
    \begin{align*}
        I(\psi) &= \int_{\Omega} \psi(x) \mu(x) \,dx - U^*(- \psi^c)\\
        I(\psi + \epsilon u) &= \int_{\Omega} (\psi + \epsilon u)(x)\mu(x) \,dx - U^*((- \psi - \epsilon u)^c)
    \end{align*}
    より、
    \begin{align*}
        I(\psi + \epsilon u) -  I(\psi) &= \int_{\Omega} (\psi + \epsilon u)(x)\mu(x) \,dx - U^*((- \psi - \epsilon u)^c) - \int_{\Omega} \psi(x) \mu(x) \,dx + U^*(- \psi^c)\\
                                        &= \int_{\Omega} (\psi + \epsilon u)(x) - \psi(x) \mu(x) \,dx -\left( U^*((- \psi - \epsilon u)^c) - U^*(- \psi^c) \right)\\
    \end{align*}
    \begin{align*}
        \lim_{\epsilon \to 0} \frac{I(\psi + \epsilon u) -  I(\psi)}{\epsilon}    &= \int_{\Omega} \lim_{\epsilon \to 0} \frac{ (\psi + \epsilon u)(x) - \psi(x)}{\epsilon} \mu(x) \, dx - \lim_{\epsilon \to 0} \frac{\left( U^*((- \psi - \epsilon u)^c) - U^*(- \psi^c) \right)}{\epsilon}\\
                                                                \delta I(\psi)(u) &= \int_{\Omega} u \mu(x) \, dx - 
    \end{align*}
    
\end{proof}

\begin{proof}[Proof of Lemma \ref{lem:Hessian bounds on the c-transform}]
    \hypertarget{proof:lem:Hessian bounds on the c-transform}{}
    \quad\par
    $\bold{Step \,\,1: ヘッセ行列(二階偏導関数)の導出}$
    $F$のヘッセ行列を求めるために、まず一階導関数から始める。
    \[
        F(\varphi + h) - F(\varphi) = \int_\Omega \left[ (\varphi + h)^c(x) - \varphi^c(x)\right] \, \mu(x) \, dx.
    \]
    ここで、$\varphi$が$c$-convexであると仮定する。
    そのため、Proposition \ref{prop:transport map}はc-変換を微分する方法を示しており、次のように書くことができる。
    \[
        \int_\Omega \left[(\varphi + h)^c(x) - \varphi^c(x) \right] \, \mu(x) \, dx = \int_\Omega -h(T_{\varphi}(x)) \, \mu(x) \, dx + o(h).\]
    従って、$\delta F(\varphi)(h)$は次のように表せる。
    \[
        \delta F(\varphi)(h) = - \int_\Omega h(T_{\varphi}(x))\, \mu(x) \, dx.\]
    $F$のヘッセ行列を導出するために、同様に2次導関数を計算する。
    \[
        \delta F(\varphi + h)(h) - \delta F(\varphi)(h) = - \int_\Omega \left[ h(T_{\varphi + h}(x)) - h(T_{\varphi}(x))\right] \, \mu(x)  \, dx.
    \]
    今度は、写像$T_\phi$を$\phi$に関して微分する必要がある。
    Proposition \ref{prop:transport map}によれば、$T_{\varphi}(x) = x - \tau \nabla \varphi^c(x)$。
    したがって、次のようになる。
    \begin{align*}
        T_{\varphi + h}(x) - T_\varphi(x) &= - \tau \nabla[(\varphi + h)^c - \varphi^c](x) \\
                                          &= - \tau \nabla(h \circ T_\varphi)(x) + o(h) \\
                                          &= - \tau D T_\varphi (x)^T \nabla h(T_\varphi(x)) + o(h).
    \end{align*}

ここで、$D T_\varphi = I_{d \times d} - \tau D^2 \varphi^c$ は対称行列であることに注意。
上記の計算から、次のようになる。
\[
    \delta F(\varphi + h)(h) - \delta F(\varphi)(h) = -  \int_\Omega \nabla h(T_\varphi(x)) \cdot (- \tau) DT_\varphi(x) \nabla h(T_\varphi (x)) \mu (x)dx + o(h).
\]
これから、次が得られる。
\[
    \delta^2 F(\varphi)(h, h) = \tau \int_\Omega \nabla h(T_\varphi(x)) \cdot DT_\varphi(x) \nabla h(T_\varphi(x)) \mu(x)dx.
\]
私たちの目標は、このヘッセを$h$のノルムで制約することである。
このために、変数変換$y = T_\varphi(x)$、または同等に$x = T_{\varphi^c}(y)$ を行います。
ここで、$T_{\varphi^c}$ は$T_\varphi$の逆変換であることに注意（Proposition \ref{prop:transport map}を参照）。
この変数変換により、次のようになります。
\[
    \delta^2 F (\varphi)(h, h) = \tau \int_\Omega \nabla h(y) \cdot DT_\varphi (T_{\varphi^c} (y))\nabla h(y) \mu(T_{\varphi^c}(y)) det DT_{\varphi^c} (y) \, dy.
\]
注意: $DT_{\varphi^c}$ は半正定値行列であるため、行列式項に絶対値は必要ありません。
また、$DT_\varphi(T_{\varphi^c}(y)) = DT_{\varphi^c}(y)^{-1}$ であることに注意し、この項を行列式と組み合わせて余因子行列として表現できます。
余因子行列は、$cof(DT) = det(DT)DT^{-1}$ と定義されます。したがって、これを以下のように表現できます：
\[
    \delta^2 F (\varphi)(h, h) = \tau \int_\Omega \nabla h(y) \cdot cof(DT_{\varphi^c} (y)\nabla h(y) \mu(T_{\varphi^c} (y)) \, dy.
\]

$\bold{Step \,\,2: ヘッセ行列の上限値}$
$\varphi$が$c$-convexであるため、$\varphi = \varphi^{cc}$、従って、$T_{\varphi^c}(y) = y - \tau \nabla \varphi(y)$。
$\varphi$の$c$-凸性はまた、対称行列$DT_{\varphi^c}(y) = I_{d \times d} + \tau D^2\varphi(y)$が半正定値であることを意味する。
今、$I_{d \times d} + \tau D^2\varphi(y) \le \Lambda I{d \cdot d}$ for all $y \in \Omega$と仮定する。
すると、$I_{d \times d} + \tau D^2\varphi(y)$は$0$から$\Lambda$までの間の固有値を持つ対称行列になる。
$DT_{\varphi^c}(y)$の余因子行列$cof (DT_{\varphi^c}(y))$の固有値は、dが空間の次元である場合、$0$から$\Lambda^(d-1)$の間にある。
したがって、我々は直ちに以下を結論づけられる：
\[
    \delta^2 F(\varphi)(h, h) \leq \tau \Lambda^{d-1}\|μ\|_{L^∞} \int |∇h(y)|^2 \, dy. 
\]

\end{proof}
\end{document}